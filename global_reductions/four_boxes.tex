\TODO{Alessio: You were right about the mistake in the following definition. I added a remark.}

%--------------------------------
\newcommand{\frfb}{{\mathsf{fb}}}
\begin{definition}\label{definition:FourBoxes}
We define the reduction $\to_\frfb$ (where $\frfb$ stands for \emph{four boxes}\index{four boxes reduction}) as follows, for any atomic flows $\phi$ and $\psi$ that do not contain any interaction or cut vertices:
\[
\atomicflow{
(-8, 6)*{\afvjdm4{\boldsymbol{\epsilon_1}}{}};
( 0, 8)*{\afaidm{\boldsymbol{\epsilon_2}}{}{}{\boldsymbol{\epsilon_3}}{}{}};
( 8, 6)*{\afvjdm4{}{\boldsymbol{\epsilon_4}}};
%-
(-5, 0)*{\affr88};
(-1, 2)*{\aflabelleft\phi};
( 5, 0)*{\affr88};
( 9, 2)*{\aflabelleft\psi};
%-
(-8,-6)*{\afvjum4{\boldsymbol{\iota_1}}{}};
( 0,-8)*{\afaium{\boldsymbol{\iota_2}}{}{}{\boldsymbol{\iota_3}}{}{}};
( 8,-6)*{\afvjum4{}{\boldsymbol{\iota_4}}};
}
\quad\to_\frfb\quad
\atomicflow{
%one
(-32,0)="A";
"A"+(-8,0)*{\invisiblemark};
"A"+( 1,18.5)*{\aflabelleft{\boldsymbol{\epsilon_1}}};
"A"+( 1,18.90)*{\afvjm{2.2}};
"A"+( 1,12.25)*{\afacumexsq{}{}{}{}{}{}84};
"A"+(-3, 5)*{\afvjm2};
"A"+( 3, 8)*{\afawdm{}{}{}{}};
%
"A"+(-3, 6.5)*{\aflabelleft{f_1(\boldsymbol{\epsilon_1})}};
"A"+( 3, 6.5)*{\aflabelleft{f_1(\boldsymbol{\epsilon_2})}};
"A"+( 0, 0)*{\affr88};
"A"+( 4, 2)*{\aflabelleft{f_1(\phi)}};
"A"+(-3,-5.5)*{\aflabelleft{f_1(\boldsymbol{\iota_1})}};
"A"+( 3,-5.5)*{\aflabelleft{f_1(\boldsymbol{\iota_2})}};
%
"A"+(-3, -5)*{\afvjm2};
"A"+( 1,-12)*{\afacdmexsq{}{}{}{}{}{}84};
"A"+( 1,-17.75)*{\aflabelleft{\boldsymbol{\iota_1}}};
"A"+( 1,-19)*{\afvjm2};
"A"+( 3, -8)*{\afawum{}{}{}{}};
%two
(-16,10)="A";
"A"+(-3,8)*{\afawdm{}{}{}{}};
"A"+(14,8)*{\afaidmex{}{}{}{}{}{}{11}2};
%
"A"+(-3, 6.5)*{\aflabelleft{f_2(\boldsymbol{\epsilon_1})}};
"A"+( 3, 6.5)*{\aflabelleft{f_2(\boldsymbol{\epsilon_2})}};
"A"+( 0, 0)*{\affr88};
"A"+( 4, 2)*{\aflabelleft{f_2(\phi)}};
"A"+(-4,-5.5)*{\aflabelleft{f_2(\boldsymbol{\iota_1})}};
"A"+( 3,-5.5)*{\aflabelleft{f_2(\boldsymbol{\iota_2})}};
%
"A"+(-7,-10)*{\afcjrm8{12}};
"A"+( 3,-8)*{\afawum{}{}{}{}};
%three
(-16,-10)="A";
"A"+( -7,10)*{\afcjlm8{12}};
"A"+(  3, 8)*{\afawdm{}{}{}{}};
%
"A"+(-4, 6.5)*{\aflabelleft{f_3(\boldsymbol{\epsilon_1})}};
"A"+( 3, 6.5)*{\aflabelleft{f_3(\boldsymbol{\epsilon_2})}};
"A"+( 0, 0)*{\affr88};
"A"+( 4, 2)*{\aflabelleft{f_3(\phi)}};
"A"+(-3,-5.5)*{\aflabelleft{f_3(\boldsymbol{\iota_1})}};
"A"+( 3,-5.5)*{\aflabelleft{f_3(\boldsymbol{\iota_2})}};
%
"A"+( 14,-8)*{\afaiumex{}{}{}{}{}{}{11}2};
"A"+(-3,-8)*{\afawum{}{}{}{}};
%four
(-2, 0)="A";
(-5, 8)*{\afawdm{}{}{}{}};
( 1, 8)*{\afvjm8};
%
"A"+(-3, 6.5)*{\aflabelleft{f_4(\boldsymbol{\epsilon_1})}};
"A"+( 3, 6.5)*{\aflabelleft{f_4(\boldsymbol{\epsilon_2})}};
"A"+( 0, 0)*{\affr88};
"A"+( 4, 2)*{\aflabelleft{f_4(\phi)}};
"A"+(-3,-5.5)*{\aflabelleft{f_4(\boldsymbol{\iota_1})}};
"A"+( 3,-5.5)*{\aflabelleft{f_4(\boldsymbol{\iota_2})}};
%
( 1,-8)*{\afvjm8};
(-5,-8)*{\afawum{}{}{}{}};
%psi
(13, 16)*{\afvjdm{8}{}{\boldsymbol{\epsilon_4}}};
(13,  8)*{\afvjum{8}{}{g(\boldsymbol{\epsilon_4})}};
( 9, 13)*{\afvjm2};
( 7,  8)*{\afacdm{}{}{}{}{}{}};
( 3, 12)*{\afaidnw{}{}};
%
(10,0)="A";
"A"+(-3, 6.5)*{\aflabelright{g(\boldsymbol{\epsilon_3})}};
"A"+( 0, 0)*{\affr88};
"A"+( 4, 2)*{\aflabelleft{g(\psi)}};
"A"+(-3,-5.5)*{\aflabelright{g(\boldsymbol{\iota_3})}};
%
( 3,-14)*{\afaiunw{}{}};
( 7, -8)*{\afacum{}{}{}{}{}{}};
( 9,-13)*{\afvjm2};
(13, -8)*{\afvjdm{8}{}{g(\boldsymbol{\iota_4})}};
(13,-16)*{\afvjum{8}{}{\boldsymbol{\iota_4}}};
(18,  0)*{\invisiblemark};
}\quad.
\]
\end{definition}
%---------------

%------------------------------------------------
\begin{remark}\label{remark:RestrictionFourBoxes}
The reduction $\to_\frfb$ would still be sound if we removed the restriction on the flows $\phi$ and $\psi$ in Definition~\ref{definition:FourBoxes}. However, such a reduction would no longer correspond to the intuition described above.

\TODO{Give intuition.}

\end{remark}
%-----------

\TODO{Alessio: Added statement about size.}

%--------------------------------------------
\begin{theorem}\label{theorem:SoundFourBoxes}
Reduction\/ $\to_\frfb$ is sound; moreover if $\Phi\to_\frfb\Psi$, then the size of $\Psi$ depends at most polynomially on the size of $\Phi$.
\end{theorem}

\begin{proof}
Let $\Phi$ be a derivation with flow $\phi'$, such that $\phi'\to_\frfb\psi'$. We show that there exists a derivation $\Psi$ with flow $\psi'$ and with the same premiss and conclusion as $\Phi$. In the following, we refer to the figure in Definition~\vref{definition:FourBoxes}.

Assume all the edges in $\phi$ are mapped to from occurrences of the atoms $a_1$, $\dots$, $a_n$, and let
\[
\vlder{\Phi'}{\{\aid,\aiu\}}
{
 \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vlsmallbrackets\vls(a_n^\phi.\bar a_n^\psi)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vlsmallbrackets\vls(a_1^\phi.\bar a_1^\psi)}]
}
{
 \vlsbr(\vlinf{}{}{\vlsmallbrackets\vls[a_1^\phi.\bar a_1^\psi]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vlsmallbrackets\vls[a_n^\phi.\bar a_n^\psi]}{\ttt}\;.\;\alpha)
}\quad,
\]
be the $\ai$-decomposed form of $\Phi$.

\TODO{Consider using $\epsilon$'s instead of $\phi$'s above.}

We show several intermediate derivations which will be used to build $\Psi$. To make it easier to verify the atomic flow of $\Psi$, we will, through a slight misuse of notation, label the atom occurrences of the intermediate derivations to indicate what atomic flow each atom occurrence will map to, once the derivations are combined to create $\Psi$.

Consider the substitution
\[
\sigma=\{a_1^\phi/\vlsmallbrackets\vlsbr([a_1^{f_1(\phi)}.a_1^{f_2(\phi)}].[a_1^{f_3(\phi)}.a_1^{f_4(\phi)}]),\dots,a_n^\phi/\vlsmallbrackets\vlsbr([a_n^{f_1(\phi)}.a_n^{f_2(\phi)}].[a_n^{f_3(\phi)}.a_n^{f_4(\phi)}])\}\;.
\]
We can then obtain, by Proposition~\vref{proposition:DerivationSubstitution}, the derivation $\Phi'\sigma$ with atomic flow
\[
\atomicflow
{
(0,0)="A";
"A"+(-3, 6)*{\afvjdm4{f_1(\boldsymbol{\epsilon_1})}{}};
"A"+( 3, 6)*{\afvjdm4{f_1(\boldsymbol{\epsilon_2})}{}};
"A"+( 0, 0)*{\affr88};
"A"+( 4, 2)*{\aflabelleft{f_1(\phi)}};
"A"+(-3,-6)*{\afvjum4{f_1(\boldsymbol{\iota_1})}{}};
"A"+( 3,-6)*{\afvjum4{f_1(\boldsymbol{\iota_2})}{}};
%---
"A"+(14, 0)="A";
"A"+(-3, 6)*{\afvjdm4{f_2(\boldsymbol{\epsilon_1})}{}};
"A"+( 3, 6)*{\afvjdm4{f_2(\boldsymbol{\epsilon_2})}{}};
"A"+( 0, 0)*{\affr88};
"A"+( 4, 2)*{\aflabelleft{f_2(\phi)}};
"A"+(-3,-6)*{\afvjum4{f_2(\boldsymbol{\iota_1})}{}};
"A"+( 3,-6)*{\afvjum4{f_2(\boldsymbol{\iota_2})}{}};
%---
"A"+(14, 0)="A";
"A"+(-3, 6)*{\afvjdm4{f_3(\boldsymbol{\epsilon_1})}{}};
"A"+( 3, 6)*{\afvjdm4{f_3(\boldsymbol{\epsilon_2})}{}};
"A"+( 0, 0)*{\affr88};
"A"+( 4, 2)*{\aflabelleft{f_3(\phi)}};
"A"+(-3,-6)*{\afvjum4{f_3(\boldsymbol{\iota_1})}{}};
"A"+( 3,-6)*{\afvjum4{f_3(\boldsymbol{\iota_2})}{}};
%---
"A"+(14, 0)="A";
"A"+(-3, 6)*{\afvjdm4{f_4(\boldsymbol{\epsilon_1})}{}};
"A"+( 3, 6)*{\afvjdm4{f_4(\boldsymbol{\epsilon_2})}{}};
"A"+( 0, 0)*{\affr88};
"A"+( 4, 2)*{\aflabelleft{f_4(\phi)}};
"A"+(-3,-6)*{\afvjum4{f_4(\boldsymbol{\iota_1})}{}};
"A"+( 3,-6)*{\afvjum4{f_4(\boldsymbol{\iota_2})}{}};
%---
"A"+(14, 0)="A";
"A"+(-3, 6)*{\afvjdm4{}{g(\boldsymbol{\epsilon_3})}{}};
"A"+( 3, 6)*{\afvjdm4{}{g(\boldsymbol{\epsilon_4})}{}};
"A"+( 0, 0)*{\affr88};
"A"+( 4, 2)*{\aflabelleft{g(\psi)}};
"A"+(-3,-6)*{\afvjum4{}{g(\boldsymbol{\iota_3})}{}};
"A"+( 3,-6)*{\afvjum4{}{g(\boldsymbol{\iota_4})}{}};
%---
}
\qquad.
\]
For every $1\le i\le n$, there exist derivations
\[
\vlinf{}{}
{
 \vls(
  [
   a_i^{f_1(\phi)}
  \;.\;
   \vlinf{}{}{a_i^{f_2(\phi)}}{\fff}
  ]
 \;.\;
  [
   a_i^{f_3(\phi)}
  \;.\;
   \vlinf{}{}{a_i^{f_4(\phi)}}{\fff}
  ]
 )  
}
{a_i}
\qquad\mbox{and}\qquad
\vls
(
 \vlinf{}{}
 {a_i}
 {
  \vlsmallbrackets\vls[a_i^{f_1(\phi)}.a_i^{f_2(\phi)}]
 }
\;.\;
 [
  \vlinf{}{}{\ttt}{a_i^{f_3(\phi)}}
 \;.\;
  \vlinf{}{}{\ttt}{a_i^{f_4(\phi)}}
 ]
)
\quad,
\]

\TODO{`build' is too vague}

which allow us to build
\[
\vlder{\Psi_\top}{}{\alpha\sigma}{\alpha}
\qquad\mbox{and}\qquad
\vlder{\Psi_\bot}{}{\beta}{\beta\sigma}
\quad,
\]
with atomic flows
\[
\atomicflow
{
( 0, 0)*{\afacumexsq{}{}{}{}{}{}52};
(-5,-3.75)*{\aflabelleft{f_1(\boldsymbol{\epsilon_1})}};
( 5,-3.75)*{\aflabelleft{f_3(\boldsymbol{\epsilon_1})}};
(12,-2)*{\afawdm{}{}{f_2(\boldsymbol{\epsilon_1})}{}};
(20,-2)*{\afawdm{}{}{f_4(\boldsymbol{\epsilon_1})}{}};
(24, 0)*{\afvjum{12}{}{g(\boldsymbol{\epsilon_4})}};
(28, 0)*{\invisiblemark};
}
\qquad\mbox{and}\qquad
\atomicflow
{
(-9,0)*{\invisiblemark};
( 0,0)*{\afacdmexsq{}{}{}{}{}{}52};
(-5,4.25)*{\aflabelleft{f_1(\boldsymbol{\iota_1})}};
( 5,4.25)*{\aflabelleft{f_2(\boldsymbol{\iota_1})}};
(12,2)*{\afawum{}{}{f_3(\boldsymbol{\iota_1})}{}};
(20,2)*{\afawum{}{}{f_4(\boldsymbol{\iota_1})}{}};
(24,0)*{\afvjdm{12}{}{g(\boldsymbol{\iota_4})}};
}
\qquad,
\]
respectively.
Furthermore, for every $1\le i\le n$, there exist derivations
\[
\Psi_{\ttt,i}\;=\;
\vlderivation
{
 \vlin{=}{}{\vls[([\vlinf{}{}{a_i^{f_1(\phi)}}{\fff}\;.\;a_i^{f_2(\phi)}]\;.\;[\vlinf{}{}{a_i^{f_3(\phi)}}{\fff}\;.\;a_i^{f_4(\phi)}])\;.\;\vlinf{}{}{\bar a_i^{g(\psi)}}{\vls[\bar a_i.\bar a_i]}]}
 {
  \vlin{\swi}{}{\vls[\vlinf{\swi}{}{\vls\vlsmallbrackets[(a_i^{f_2(\phi)}.a_i^{f_4(\phi)}).\bar a_i]}{\vls\vlsmallbrackets(a_i^{f_2(\phi)}.[a_i^{f_4(\phi)}.\bar a_i])}\;.\;\bar a_i]}
  {
   \vlhy{\vls(\vlinf{}{}{\vls[a_i^{f_2(\phi)}.\bar a_i]}{\ttt}\;.\;\vlinf{}{}{\vls[a_i^{f_4(\phi)}.\bar a_i]}{\ttt})}
  }
 }
}
\]
and
\[
\Psi_{\fff,i}\;=\;
\vlderivation
{
 \vlin{\swi}{}{\vls[\vlinf{}{}{\fff}{\vls(a_i^{f_3(\phi)}.\bar a_i)}\;.\;\vlinf{}{}{\fff}{\vls(a_i^{f_4(\phi)}.\bar a_i)}]}
 {
  \vlin{=}{}{\vls(\vlinf{\swi}{}{\vls[a_i^{f_3(\phi)}.(a_i^{f_4(\phi)}.\bar a_i)]}{\vls([a_i^{f_3(\phi)}.a_i^{f_4(\phi)}].\bar a_i)}\;.\;\bar a_i)}
  {
   \vlhy{\vls(([\vlinf{}{}{\ttt}{a_i^{f_1(\phi)}}\;.\;\vlinf{}{}{\ttt}{a_i^{f_2(\phi)}}]\;.\;\vlsmallbrackets[a_i^{f_3(\phi)}.a_i^{f_4(\phi)}])\;.\;\vlinf{}{}{\vls(\bar a_i.\bar a_i)}{\bar a_i^{g(\psi)}})}
  }
 }
}\quad,
\]
which allow us to build
\[
\Psi_\ttt\;=\;
\vlsbr
(
 \vlder{\Psi_{\ttt,1}}{}
 {
  \vlsmallbrackets\vlsbr[a^\phi_1.\bar a^\psi_1]\sigma
 }
 {
  \ttt
 }
\;\;.\;\;\cdots\;\;.\;\;
 \vlder{\Psi_{\ttt,n}}{}
 {
  \vlsmallbrackets\vlsbr[a^\phi_n.\bar a^\psi_n]\sigma
 }
 {
  \ttt
 }
)
\qquad\mbox{and}\qquad
\Psi_\fff\;=\;
\vlsbr
[
 \vlder{\Psi_{\fff,n}}{}
 {
  \fff
 }
 {
  \vlsmallbrackets\vlsbr(a^\phi_n.\bar a^\psi_n)\sigma
 }
\;\;.\;\;\cdots\;\;.\;\;
 \vlder{\Psi_{\fff,1}}{}
 {
  \fff
 }
 {
  \vlsmallbrackets\vlsbr(a^\phi_1.\bar a^\psi_1)\sigma
 }
]
\quad,
\]
with atomic flows
\[
\atomicflow
{
(-12,0)*{\afawdm{}{}{f_1(\boldsymbol{\epsilon_2})}{}};
(-6,0)*{\afvjum8{f_2(\boldsymbol{\epsilon_2})}{}};
(-4,4)*{\afaidnw{}{}};
( 0,0)*{\afacdm{}{}{}{}{g(\boldsymbol{\epsilon_3})}{}};
( 4,4)*{\afaidnw{}{}};
( 6,0)*{\afvjum8{f_4(\boldsymbol{\epsilon_2})}{}};
(12,0)*{\afawdm{}{}{f_3(\boldsymbol{\epsilon_2})}{}};
}
\qquad\mbox{and}\qquad
\atomicflow
{
(-22, 0)*{\invisiblemark};
(-18, 0)*{\afawum{}{}{f_1(\boldsymbol{\iota_2})}{}};
(-12, 0)*{\afawum{}{}{f_2(\boldsymbol{\iota_2})}{}};
(  6, 0)*{\afvjdm8{f_4(\boldsymbol{\iota_2})}{}};
(  4,-6)*{\afaiunw{}{}};
(  0, 0)*{\afacum{}{}{}{}{g(\boldsymbol{\iota_3})}{}};
( -4,-6)*{\afaiunw{}{}};
( -6, 0)*{\afvjdm8{f_3(\boldsymbol{\iota_2})}{}};
}
\qquad,
\]
respectively.
Combining these derivations we can build
\[
\Psi\;=\;
\vlderivation
{
 \vlde{\vls[\Psi_\bot.\Psi_\fff]}{}
 {
  \beta
 }
 {
  \vlde{\Phi'\sigma}{}
  {
   \vlsbr[\beta.(a^\phi_n.\bar a^\psi_n).\cdots.(a^\phi_1.\bar a^\psi_1)]\sigma
  }
  {
   \vlde{\vls(\Psi_\ttt.\Psi_\top)}{}
   {
    \vlsbr([a^\phi_1.\bar a^\phi_1].\cdots.[a^\phi_n.\bar a^\phi_n].\alpha)\sigma
   }
   {
    \vlhy
    {
     \alpha
    }
   }
  }
 }
}\quad,
\]
with the desired atomic flow.

We know that the size of $\Phi'\sigma$ depends at most polynomially on the size of $\Phi$ by Theorem~\vref{theorem:aiDecomposedForm} and Proposition~\vref{proposition:DerivationSubstitution}, and it is straightforward to observe that the sizes of $\Psi_\ttt$, $\Psi_\top$, $\Psi_\fff$ and $\Psi_\bot$ depend at most linearly on the size of $\Phi$, so the size of $\Psi$ depends at most polynomially on the size of $\Phi$.
\end{proof}
%----------

\TODO{Think hard about the next definition and decide if it makes more sense to define with respect to atoms instead of with respect to polarity.}

%----------------------------------
\newcommand{\Simpl}{\mathsf{Simpl}}
\begin{definition}\label{definition:DerSimpleForm}
Given a derivation $\Phi$ with atomic flow $\phi$ and a polarity assignment $\pi$, let $\Psi$ with atomic flow $\psi$ be the derivation obtained in the proof of Theorem~\ref{theorem:SoundFourBoxes}, such that $\phi\to_\frfb\psi$, then we say that $\Psi$ is \emph{the} (\emph{canonical}) \emph{simple form of\/ $\Phi$ with respect to $\pi$}\index{simple form!derivation}, denoted $\Simpl(\Phi,\pi)$.
\end{definition}
%---------------

\TODO{What is the role of $\pi$? Answer: the lemma holds for any $\Psi$, such that $\Phi\to_\frfb\Psi$, we just happen to be interested in $\Simpl(\Phi,\pi)$. Decide on how to phrase it.}

%---------------------------------------
\begin{lemma}\label{lemma:SizeFourBoxes}
Given a derivation $\Phi$ and a polarity assignment for its atomic flow $\pi$, the size of $\Simpl(\Phi,\pi)$ depends linearly on the size of $\Phi$.
\end{lemma}

\begin{proof}
Since the formulae we substitute with in the proof of Theorem~\vref{theorem:SoundFourBoxes} have size 4, the result follows by Proposition~\vref{proposition:DerivationSubstitution}.
\end{proof}
%----------

%-----------------------------------------------
\begin{lemma}\label{lemma:FourBoxesStreamlining}
Given two atomic flows $\phi$ and $\psi$ with polarity assignment $\pi$, such that $\phi\to_\frfb\psi$ and $\phi$ is weakly streamlined with respect to $\bar\pi$ then $\psi$ is weakly streamlined with respect to $\bar\pi$.
\end{lemma}

\begin{proof}
By studying the atomic flows in Definition~\vref{definition:FourBoxes} we can observe that for every path from an interaction vertex to a cut vertex in $\psi$ there is a path from an interaction vertex to a cut vertex in $\phi$ with the same polarity assignment.
\end{proof}
%----------
