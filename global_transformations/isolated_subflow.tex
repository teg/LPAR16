\TODO{Throughout: use `isolated subflow' and define it somewhere else.}

\TODO{Changes:
\begin{itemize}
\item changed $\bar a$ into $a$ in the proof of Theorem~\vref{theorem:SoundIsolatedSubflowRemoval};
\item added restriction to $\psi$ in Definition~\ref{definition:IsolatedSubflowRemoval} and explained it (and why we don't need it) in Remark~\ref{remark:IsolatedSubflowRemovalRestriction};
\item required $\Phi$ to be in simple form with respect to $a$ in Definition~\vref{definition:IsolatedSublfowRemover}, in order for case 1 of Proposition~\vref{proposition:IsolatedSubflowRemover} to be true.
\item take advantage of not having $\bar a$ mapped to $\psi$ to simplify the substitutions in soundness proof;
\item made Lemma~\vref{lemma:IsolatedSubflowRemovalPaths} more generic; and
\item proved Proposition~\ref{proposition:IsolatedSubflowRemover}.
\end{itemize}
}

\newcommand{\fris}{{\mathsf{is}}}
%---------------------------------------
\begin{definition}\label{definition:IsolatedSubflowRemoval}
We define the reduction $\to_\fris$ (where $\fris$ stands for \emph{isolated subflow}) as follows, for any atomic flow $\phi$ and any connected atomic flow $\psi$ that does not contain identity or cut vertices:
\[
\atomicflow{
(-8, 6)*{\afvjdm4{\boldsymbol\epsilon}{}};
( 1, 8)*{\afaidex{}{}{}{}{}{}{6}{4}};
(-5, 0)*{\affr{8}{8}};
(-4, 2)*{\aflabelright{\phi}};
( 4, 0)*{\affr{6}{8}};
( 4, 2)*{\aflabelright{\psi}};
( 1,-8)*{\afaiuex{}{}{}{}{}{}{6}{4}};
(-8,-6)*{\afvjum4{\boldsymbol\iota}{}};
}
\quad\to_\fris\quad
\atomicflow{
( 0, 16.5)*{\afacumexsq{f_2(\boldsymbol\epsilon)}{}{}{f_1(\boldsymbol\epsilon)}{\boldsymbol\epsilon}{}{12}{4}};
(-6,  4  )*{\afvjm{12}};
( 0, 14  )*{\afawd{}{}{}{}};
( 3,  6  )*{\affr{8}{8}};
( 2,  8  )*{\aflabelright{f_1(\phi)}};
( 0,  0  )*{\afvj4};
(-3, -6  )*{\affr{8}{8}};
(-4, -4  )*{\aflabelright{f_2(\phi)}};
( 0,-14  )*{\afawu{}{}{}{}};
( 6, -4  )*{\afvjm{12}};
( 0,-16  )*{\afacdmexsq{f_2(\boldsymbol\iota)}{}{}{f_1(\boldsymbol\iota)}{\boldsymbol\iota}{}{12}{4}};
}\quad.
\]
\end{definition}

\begin{remark}\label{remark:IsolatedSubflowRemovalRestriction}
The condition on the atomic flow $\psi$ in Definition~\ref{definition:IsolatedSubflowRemoval} ensures that all the edges in $\psi$ are mapped to from occurrences of the same atom. However, the reduction would still be sound if, at the expense of a slightly more verbose soundness proof, we relaxed the condition to say that the upper and lower edge of $\psi$ belong to the same connected component.
\end{remark}

%---------------------------------------
\begin{theorem}\label{theorem:SoundIsolatedSubflowRemoval}
Reduction\/ $\to_\fris$ is sound.
\end{theorem}

%---------------------------------------
\begin{proof}
Let $\Phi$ be a derivation with flow $\phi'$, such that $\phi'\to_\fris\psi'$. We show that there exists a derivation $\Psi$ with flow $\psi'$ and with the same premiss and conclusion as $\Phi$. In the following, we refer to the figure in Definition~\ref{definition:IsolatedSubflowRemoval}.

Since $\psi$ is connected, we assume, by Remark~\vref{remark:AlternativeAiDecomposedForm}, that the following derivation is an $\ai$-decomposed form of $\Phi$:
\[
\vlder{\Phi'}{}
{
 \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(a^\psi.\bar a)}]
}
{
 \vlsbr(\vlinf{}{}{\vls[a^\psi.\bar a]}{\ttt}\;.\;\alpha)
}\quad,
\]
for some atom $a$ and formulae $\alpha$ and $\beta$.

We obtain the two derivations $\Phi_\ttt$ and $\Phi_\fff$ from $\Phi'$ as follows:
\[
\Phi_\ttt\;=\;
\vlder{\Phi'\{a^\psi/\ttt\}}{}
{
 \vls[\beta.\bar a]
}
{
 \vls([\ttt.\bar a].\alpha)
}
\qquad\mbox{and}\qquad
\Phi_\fff\;=\;
\vlder{\Phi'\{a^\psi/\fff\}}{}
{
 \vls[\beta.(\fff.\bar a)]
}
{
 \vls(\bar a.\alpha)
}\quad.
\]
Since $\psi$ is connected and contains no identity or cut vertices, the mapping from all the occurrences $a^\psi$ to edges of $\psi$ is surjective. Hence, we know that both derivation $\Phi_\ttt$ and $\Phi_\fff$ have a flow isomorphic to $\phi$. We combine $\Phi_\ttt$ and $\Phi_\fff$ to get the desired derivation $\Psi$ with flow $\psi'$ and the same premiss and conclusion as $\Phi$:
\[
\Psi\;=\;
\vlderivation
{
 \vlin{\cod}{}
 {
  \beta
 }
 {
  \vlin{\swi}{}
  {
   \vls
   [
    \beta
   \;\;\;.\;\;\;
    \vlder{\Phi_\fff}{}
    {
     \vlsbr[\beta\;.\;(\fff\;.\;\vlinf{}{}{\ttt}{\bar a})]
    }
    {
     \vls(\bar a.\alpha)
    }
   ]
  }
  {
   \vlin{\cou}{}
   {
    \vls
    (
     \vlder{\Phi_\ttt}{}
     {
      \vls[\beta.\bar a]
     }
     {
      \vlsbr([\ttt\;.\;\vlinf{}{}{\bar a}{\fff}]\;.\;\alpha)
     }
    \;\;\;.\;\;\;
     \alpha
    )
   }
   {
    \vlhy{\alpha}
   }
  }
 }
}\quad.
\]
\end{proof}

%-----------------------------------------------------
\begin{lemma}\label{lemma:IsolatedSubflowRemovalPaths}
Given two atomic flows $\phi$ and $\psi$, such that $\phi\to_\fris\psi$, and given an interaction (resp., cut) vertex $\nu$ in $\psi$, then there is an interaction (resp., cut) vertex $\nu'$ in $\phi$ such that $\nu=f_1(\nu')$ or $\nu=f_2(\nu')$, and
\begin{itemize}
\item if there is a path from $\nu$ to $\bot$ (resp., $\top$) in $\psi$, then there is a path from $\nu'$ to $\bot$ (resp., $\top$) in $\phi$; and
\item if there is a cut (resp., interaction) vertex $\hat\nu$ in $\psi$, such that there is a path from $\nu$ to $\hat\nu$ in $\psi$, then there is a cut (resp., interaction) vertex $\hat\nu'$ in $\phi$, such that $\hat\nu=f_1(\hat\nu')$ or $\hat\nu=f_2(\hat\nu')$ and there is a path from $\nu'$ to $\hat\nu'$ in $\phi$.
\end{itemize}
\end{lemma}

\begin{proof}
By a case analysis on the atomic flows in Definition~\vref{definition:IsolatedSubflowRemoval}.
\end{proof}

\newcommand{\ISR}{\mathsf{ISR}}
\begin{definition}\label{definition:IsolatedSubflowRemover}
The \emph{isolated subflow remover}, $\ISR$, is an operator whose arguments are an atom $a$, and a derivation $\Phi$ that is on simple form with respect to $a$, such that
\[
\Phi\;=\;
\vlder{\Phi'}{}
{
 \vlsbr
 [
  \beta
 \;.\;
  \vlinf{}{}
  {
   \fff
  }
  {
   \vls(a^\psi.\bar a)
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \fff
  }
  {
   \vls(a^\psi.\bar a)
  }
 ]
}
{
 \vlsbr
 (
  \vlinf{}{}
  {
   \vls[a^\psi.\bar a]
  }
  {
   \ttt
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \vls[a^\psi.\bar a]
  }
  {
   \ttt
  }
 \;.\;
  \alpha
 )
}\quad,
\]
with atomic flow
\[
\atomicflow{
(-8, 6)*{\afvjdm4{\boldsymbol\epsilon}{}};
( 1, 8)*{\afaidmex{}{}{}{}{}{}{6}{4}};
(-5, 0)*{\affr{8}{8}};
(-1, 2)*{\aflabelleft{\phi}};
( 4, 0)*{\affr{6}{8}};
( 7, 2)*{\aflabelleft{\psi}};
( 1,-8)*{\afaiumex{}{}{}{}{}{}{6}{4}};
(-8,-6)*{\afvjum4{\boldsymbol\iota}{}};
}
\quad,
\]
where $\psi$ is the juxtaposition of all the isolated subflows mapped to from occurrences of $a$ in $\Phi$. Consider the derivation
\[
\Psi'\;=\;
\vlder{\Phi'}{}
{
 \vlsbr
 [
  \beta
 \;\;\;.\;\;\;
  \vlderivation
  {
   \vlin{}{}
   {
    \fff
   }
   {
    \vlde{}{\{\cod\}}
    {
     \vls(a.\bar a)
    }
    {
     \vlhy
     {
      \vls[(a.\bar a).\cdots.(a.\bar a)]
     }
    }
   }
  }
 ]
}
{
 \vlsbr
 (
  \vlderivation
  {
   \vlde{}{\{\cou\}}
   {
    \vls([a.\bar a].\cdots.[a.\bar a])
   }
   {
    \vlin{}{}
    {
     \vls[a.\bar a]
    }
    {
     \vlhy
     {
      \ttt
     }
    }
   }
  }
 \;\;\;.\;\;\;
  \alpha
 )
}\quad,
\]
with atomic flow
\[
\psi'\;=\;
\atomicflow{
(-8, 11)*{\afvjdm{14}{\boldsymbol\epsilon}{}};
( 2, 18)*{\afaidex{}{}{}{}{}{}{8}{4}};
%-
(-2, 10)*{\affr68};
(-2, 10)*{\copy\contrup};
(-2,  5)*{\afvjm2};
(-5,  0)*{\affr{8}{8}};
(-1,  2)*{\aflabelleft{\phi}};
(-2, -5)*{\afvjm2};
(-2,-10)*{\affr68};
(-2,-10)*{\copy\contrdown};
%-
( 6, 10)*{\affr68};
( 6, 10)*{\copy\contrup};
( 6,  5)*{\afvjm2};
( 6,  0)*{\affr{6}{8}};
( 9,  2)*{\aflabelleft{\psi}};
( 6, -5)*{\afvjm2};
( 6,-10)*{\affr68};
( 6,-10)*{\copy\contrdown};
%-
( 2,-18)*{\afaiuex{}{}{}{}{}{}{8}{4}};
(-8,-11)*{\afvjum{14}{\boldsymbol\iota}{}};
}\quad.
\]
We then define $\ISR(\Phi,a)$ to be such that $\Psi'\to_\fris\ISR(\Phi,a)$, where $\psi$ in $\psi'$ is a sublfow of $\psi$ in the redex of Definition~\vref{definition:IsolatedSubflowRemoval}.
\end{definition}

\TODO{Unique?}

%------------------------------------------------------------
\begin{proposition}\label{proposition:IsolatedSubflowRemover}
Given an atom $a$, and a derivation $\Phi$ as described in Definition~\ref{definition:IsolatedSubflowRemover},
\begin{enumerate}
\item $\ISR(\Phi,a)$ is weakly streamlined with respect to $a$;
\item for any atom $b$,
\begin{itemize}
\item if $\Phi$ is weakly streamlined with respect to $b$, then $\ISR(\Phi,a)$ is weakly streamlined with respect to $b$, and
\item if $\Phi$ is on simple form with respect to $b$, then $\ISR(\Phi,a)$ is on simple form with respect to $b$; and
\end{itemize}
\item the size of $\ISR(\Phi,a)$ depends linearly on the size of\/ $\Phi$.
\end{enumerate}
\end{proposition}

\begin{proof}
The statements follow by
\begin{enumerate}
\item Definition~\vref{definition:DerStreamlined} and Lemma~\vref{lemma:IsolatedSubflowRemovalPaths};
\item Definitions~\ref{definition:DerStreamlined} and \ref{definition:DerSimpleForm}, and Lemma~\ref{lemma:IsolatedSubflowRemovalPaths};
\item Proposition~\vref{proposition:DerivationSubstitution}.
\end{enumerate}
\end{proof}
%----------