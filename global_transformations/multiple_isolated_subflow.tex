\newcommand{\Gammasf}{\mathsf\Gamma}

\newcommand{\frmis}{{\mathsf{mis}}}
%---------------------------------------
\begin{definition}\label{definition:MultipleIsolatedSubflowsRemoval}
Given $n>0$ distinct atoms $a_1$, $\dots$, $a_n$, an $N>0$, for $0\le k\le N$, a derivation $\Gammasf_k$, and, for $0\le k\le N$, formulae $\gamma_{k,1}$, $\dots$, $\gamma_{k,n}$, such that
\begin{itemize}
 \item $\gamma_{0,1}=\cdots=\gamma_{0,n}=\ttt$;
 \item $\gamma_{N,1}=\cdots=\gamma_{N,n}=\fff$; and
 \item 
\[
\Gammasf_k\quad=\quad
\vlder{}{\SKS\setminus\{\aid,\aiu\}}
{
 \vls([a_1.\gamma_{k,1}].\cdots.[a_n.\gamma_{k,n}])
}
{
 \vls[(a_1.\gamma_{k-1,1}).\cdots.(a_n.\gamma_{k-1,n})]
}\quad.
\]
\end{itemize}
Let $\eta_k$ be the atomic flow of\/ $\Gammasf_k$, and let
\[
\mu_k\;=\;
\atomicflow
{
(  4,  0)*{\affr{8}{8}};
(  8,  2)*{\aflabelleft{f_{1,1}(\psi_1)}};
( 10,  0)*{\cdots};
( 16,  0)*{\affr{8}{8}};
( 20,  2)*{\aflabelleft{f_{1,l_1}(\psi_1)}};
( 22,  0)*{\cdots};
( 28,  0)*{\affr{8}{8}};
( 32,  2)*{\aflabelleft{f_{n,1}(\psi_n)}};
( 34,  0)*{\cdots};
( 40,  0)*{\affr{8}{8}};
( 44,  2)*{\aflabelleft{f_{n,l_n}(\psi_n)}};
}
\quad,
\]
where $l_i$ is the number of atom occurrences in $\gamma_{k,i}$, we define the reduction $\to_\frmis$ (where $\frmis$ stands for \emph{multiple isolated subflows}) as follows, for any atomic flow $\phi$ and any connected atomic flows $\psi_1$, $\dots$, $\psi_n$ that do not contain interaction or cut vertices:
\[
\atomicflow{
(-12,  8)*{\afvjdm8{}{\boldsymbol\epsilon}};
(  4, 10)*{\afaidex{}{}{}{}{}{}{20}{4}};
( -6,  5)*{\afvj2};
( -4,  6)*{\cdots};
( 14,  5)*{\afvj2};
(  1,  8)*{\afaidex{}{}{}{}{}{}{6}{4}};
( -7,  0)*{\affr{12}{8}};
( -4,  2)*{\aflabelright{\phi}};
(  4,  0)*{\affr{6}{8}};
(  4,  2)*{\aflabelright{\psi_1}};
(  9,  0)*{\cdots};
( 14,  0)*{\affr{6}{8}};
( 14,  2)*{\aflabelright{\psi_n}};
(  1, -8)*{\afaiuex{}{}{}{}{}{}{6}{4}};
( -6, -5)*{\afvj2};
( -4, -6)*{\cdots};
( 14, -5)*{\afvj2};
(  4,-10)*{\afaiuex{}{}{}{}{}{}{20}{4}};
(-12, -8)*{\afvjum8{}{\boldsymbol\iota}};
}
\quad\to_\frmis\quad
\atomicflow{
(-12, 56)*{\afvjm4};
(-12, 50)*{\copy\contrup};
(-12, 50)*{\affr{16}{8}};
( -5, 44)*{\afvjdm4{}{f_0(\boldsymbol\epsilon)}};
( -7, 34)*{\afcjlm{4}{24}};
(-12, 42)*{\cdots};
(-10,  2)*{\afcjlm{10}{32}};
(-15, 32)*{\afvjm{28}};
(-12,-13)*{\afcjlm{14}{42}};
(-19, 27)*{\afvjm{38}};
%--
( 5, 46)*{\afawdm{}{}{}{}};
( 0, 38)*{\affr{12}{8}};
( 1, 40)*{\aflabelright{f_0(\phi)}};
( 5, 33)*{\afvjm2};
( 9, 28)*{\affr{10}{8}};
(11, 30)*{\aflabelright{\eta_0}};
( 5, 23)*{\afvjm2};
(11, 23)*{\afvjm2};
( 0, 18)*{\affr{12}{8}};
( 1, 20)*{\aflabelright{f_1(\phi)}};
( 5, 13)*{\afvjm2};
(11, 13)*{\afvjm2};
(11, 18)*{\affr{6}{8}};
(11, 20)*{\aflabelright{\mu_1}};
( 9,  8)*{\affr{10}{8}};
(11, 10)*{\aflabelright{\eta_1}};
( 5,  3)*{\afvjm2};
(11,  3)*{\afvjm2};
%-
( 0,  1)*{\vdots};
%-
( 5, -3)*{\afvjm2};
(11, -3)*{\afvjm2};
( 9, -8)*{\affr{10}{8}};
( 9, -6)*{\aflabelright{\eta_{n-1}}};
( 5,-13)*{\afvjm2};
(11,-13)*{\afvjm2};
( 0,-18)*{\affr{12}{8}};
( 1,-16)*{\aflabelright{f_n(\phi)}};
(11,-18)*{\affr{6}{8}};
(11,-16)*{\aflabelright{\mu_n}};
( 5,-23)*{\afvjm2};
(11,-23)*{\afvjm2};
( 9,-28)*{\affr{10}{8}};
(11,-26)*{\aflabelright{\eta_n}};
( 5,-33)*{\afvjm2};
( 0,-38)*{\affr{12}{8}};
(-1,-36)*{\aflabelright{f_{n+1}(\phi)}};
( 5,-46)*{\afawum{}{}{}{}};
%--
(-12, 13)*{\afcjrm{14}{42}};
(-19,-27)*{\afvjm{38}};
(-10, -2)*{\afcjrm{10}{32}};
(-15,-32)*{\afvjm{28}};
(-12,-42)*{\cdots};
( -7,-34)*{\afcjrm{4}{24}};
( -5,-44)*{\afvjum4{}{f_{n+1}(\boldsymbol\iota)}};
(-12,-50)*{\affr{16}{8}};
(-12,-50)*{\copy\contrdown};
(-12,-56)*{\afvjm4};
}\quad.
\]
\end{definition}

\begin{theorem}\label{theorem:SoundMultipleIsolatedSubflowsRemoval}
Reduction\/ $\to_\frmis$ is sound.
\end{theorem}

%-------------------------------------------------------------------------------
\begin{proof}
Let $\Phi$ be a derivation with flow $\phi'$, such that $\phi'\to_\frmis\psi'$. We show that there exists a derivation $\Psi$ with flow $\psi'$ and with the same premiss and conclusion as $\Phi$. In the following, we refer to the figures in Definition~\vref{definition:MultipleIsolatedSubflowsRemoval}.

Since each of $\psi_1$, $\dots$, $\psi_n$ is connected, we can assume that the $\ai$-decomposed form of $\Phi$ is
\[
\vlder{\Phi'}{}
{
 \vls[\beta\;.\;\vlinf{}{}{\fff}{\vls(a_1.\bar a_1^{\psi_1})}\;.\;\vlinf{}{}{\fff}{\vls(a_n.\bar a_n^{\psi_n})}]
}
{
 \vls(\vlinf{}{}{\vls[a_1.\bar a_1^{\psi_1}]}{\ttt}\;.\;\vlinf{}{}{\vls[a_n.\bar a_n^{\psi_n}]}{\ttt}\;.\;\alpha)
}\quad,
\]
for some atoms $a_1$, $\dots$, $a_n$ and formulae $\alpha$ and $\beta$.

For every $0\le k\le N$, we obtain the derivation $\Phi_k$ from $\Phi'$ as follows:
\[
\Phi_k\quad=\quad
\vlder{\Phi'\{\bar a_1^{\psi_1}/\gamma_{k,1},\dots,\bar a_n^{\psi_n}/\gamma_{k,n}\}}{}
{
 \vlsbr[\beta.(a_1.\gamma_{k,1}).\cdots.(a_n.\gamma_{k,n})]
}
{
 \vls([a_1.\gamma_{k,1}].\cdots.[a_n.\gamma_{k,n}].\alpha)
}
\]
Since each of $\psi_1$, $\dots$, $\psi_n$ is connected and contains no interaction or cut vertices, the mapping from occurrences of $\bar a_i^{\psi_i}$ to edges of $\psi_i$ is surjective. Hence, we know that $\Phi_k$ has atomic flow
\[
\atomicflow{
(-5, 6)*{\afvjm4};
( 1, 6)*{\afvj4};
( 3, 6)*{\cdots};
( 5, 6)*{\afvj4};
(11, 6)*{\afvjm4};
( 0, 0)*{\affr{12}{8}};
( 3, 2)*{\aflabelright{\phi}};
(11, 0)*{\affr{6}{8}};
(11, 2)*{\aflabelright{\mu_k}};
(-5,-6)*{\afvjm4};
( 1,-6)*{\afvj4};
( 3,-6)*{\cdots};
( 5,-6)*{\afvj4};
(11,-6)*{\afvjm4};
}\quad.
\]
We combine $\Phi_0$, $\dots$, $\Phi_N$, $\Gammasf_1$, $\dots$, $\Gammasf_N$ to get the desired derivation $\Psi$ with atomic flow $\psi'$ and the same premiss and conclusion as $\Phi$:
\[
\vlderivation
{
 \vlin{\cod}{}
 {
  \beta
 }
 {
  \vlin{\swi}{}
  {
   \vls
   [
    \vlinf{\cod}{}{\beta}{\vls[\beta.\beta]}
   \;\;\;.\;\;\;
    \vlder{\Phi_N}{}
    {
     \vlsbr[\beta\;.\;(\vlinf{}{}{\ttt}{a_1}\;.\;\fff)\;.\;\cdots\;.\;(\vlinf{}{}{\ttt}{a_n}\;.\;\fff)]
    }
    {
     \vls([a_1.\gamma_{N,1}].\cdots.[a_n.\gamma_{N,n}].\alpha)
    }
   ]
  }
  {
   \vlin{\swi}{}
   {
    \vls
    (
     [
      \vlinf{\cod}{}{\beta}{\vls[\beta.\beta]}
     \;\;\;\;.\;\;\;\;
      \vlder{\Phi_{N-1}}{}
      {
       \vlsbr
       [
        \beta
       \;\;.\;\;
        \vlder{\Gammasf_N}{}
        {
         \vls([a_1.\gamma_{N,1}].\cdots.[a_n.\gamma_{N,n}])
        }
        {
         \vls[(a_1.\gamma_{N-1,1}).\cdots.(a_n.\gamma_{N-1,n})]
        }
       ]
      }
      {
       \vls([(a_1.\gamma_{N-1,1}).\cdots.(a_n.\gamma_{N-1,n})].\alpha)
      }
     ]
    \;\;\;\;.\;\;\;\;
     \alpha
    )
   }
   {
    \vlin{\swi}{}
    {
     \vdots
    }
    {
     \vlin{\swi}{}
     {
      \vls
      (
       [
        \beta
       \;\;\;\;.\;\;\;\;
        \vlder{\Phi_1}{}
        {
         \vlsbr
         [
          \beta
         \;\;.\;\;
          \vlder{\Gammasf_2}{}
          {
           \vls([a_1.\gamma_{2,1}].\cdots.[a_n.\gamma_{2,n}])
          }
          {
           \vls[(a_1.\gamma_{1,1}).\cdots.(a_n.\gamma_{1,n})]
          }
         ]
        }
        {
         \vls((a_1.\gamma_{0,1}).\cdots.(a_n.\gamma_{0,n}).\alpha)
        }
       ]
      \;\;\;\;.\;\;\;\;
       \vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha}
      )
     }
     {
      \vlin{\cou}{}
      {
       \vls
       (
        \vlder{\Phi_0}{}
        {
         \vlsbr
         [
          \beta
         \;\;.\;\;
          \vlder{\Gammasf_1}{}
          {
           \vls([a_1.\gamma_{1,1}].\cdots.[a_n.\gamma_{1,n}])
          }
          {
           \vls[(a_1.\gamma_{0,1}).\cdots.(a_n.\gamma_{0,n})]
          }
         ]
        }
        {
         \vlsbr([\vlinf{}{}{a_1}{\fff}\;.\;\ttt]\;.\;\cdots\;.\;[\vlinf{}{}{a_n}{\fff}\;.\;\ttt]\;.\;\alpha)
        }
       \;\;\;\;.\;\;\;\;
        \vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha}
       )
      }
      {
       \vlhy{\alpha}
      }
     }
    }
   }
  }
 }
}
\qquad.
\]
\end{proof}

\newcommand{\MISR}{\mathsf{MISR}}
\begin{definition}
For every $n\ge1$, given an $N\ge0$, formulae $\gamma_{i,k}$ and derivations $\Gammasf_k$ as described in Definition~\vref{definition:MultipleIsolatedSubflowsRemoval}, the \emph{multiple isolated subflow remover}, $\MISR_n$, is an operator whose arguments are distinct and mutually non-dual atoms $a_1$, $\dots$, $a_n$, and a derivation of shape
\[
\Phi\;=\;
\vlder{\Phi'}{}
{
 \vlsbr
 [
  \beta
 \;.\;
  \vlinf{}{}
  {
   \fff
  }
  {
   \vls(a_n^{\psi_n}.\bar a_n)
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \fff
  }
  {
   \vls(a_n^{\psi_n}.\bar a_n)
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \fff
  }
  {
   \vls(a_1^{\psi_1}.\bar a_1)
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \fff
  }
  {
   \vls(a_1^{\psi_1}.\bar a_1)
  }
 ]
}
{
 \vlsbr
 (
  \vlinf{}{}
  {
   \vls[a_1^{\psi_1}.\bar a_1]
  }
  {
   \ttt
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \vls[a_1^{\psi_1}.\bar a_1]
  }
  {
   \ttt
  }
 \;.\;
  \vlinf{}{}
  {
   \vls[a_n^{\psi_n}.\bar a_n]
  }
  {
   \ttt
  }
 \;.\;\cdots\;.\;
  \vlinf{}{}
  {
   \vls[a_n^{\psi_n}.\bar a_n]
  }
  {
   \ttt
  }
 \;.\;
  \alpha
 )
}\quad,
\]
with atomic flow
\[
\atomicflow{
(-12,  8)*{\afvjdm8{}{\boldsymbol\epsilon}};
(  4, 10)*{\afaidmex{}{}{}{}{}{}{20}{4}};
( -6,  5)*{\afvjm2};
( -4,  6)*{\cdots};
( 14,  5)*{\afvjm2};
(  1,  8)*{\afaidmex{}{}{}{}{}{}{6}{4}};
( -7,  0)*{\affr{12}{8}};
( -4,  2)*{\aflabelright{\phi}};
(  4,  0)*{\affr{6}{8}};
(  4,  2)*{\aflabelright{\psi_1}};
(  9,  0)*{\cdots};
( 14,  0)*{\affr{6}{8}};
( 14,  2)*{\aflabelright{\psi_n}};
(  1, -8)*{\afaiumex{}{}{}{}{}{}{6}{4}};
( -6, -5)*{\afvjm2};
( -4, -6)*{\cdots};
( 14, -5)*{\afvjm2};
(  4,-10)*{\afaiumex{}{}{}{}{}{}{20}{4}};
(-12, -8)*{\afvjum8{}{\boldsymbol\iota}};
}
\quad,
\]
where, for $1\le i\le n$, $\psi_i$ is the juxtaposition of all the isolated subflows mapped to from occurrences of $a_i$ in $\Phi$. Consider the derivation
\[
\Psi'\;=\;
\vlder{\Phi'}{}
{
 \vlsbr
 [
  \beta
 \;\;\;.\;\;\;
  \vlderivation
  {
   \vlin{}{}
   {
    \fff
   }
   {
    \vlde{}{\{\cod\}}
    {
     \vls(a_n.\bar a_n)
    }
    {
     \vlhy
     {
      \vls[(a_n.\bar a_n).\cdots.(a_n.\bar a_n)]
     }
    }
   }
  }
 \;\;\;.\;\;\;\cdots\;\;\;.\;\;\;
  \vlderivation
  {
   \vlin{}{}
   {
    \fff
   }
   {
    \vlde{}{\{\cod\}}
    {
     \vls(a_1.\bar a_1)
    }
    {
     \vlhy
     {
      \vls[(a_1.\bar a_1).\cdots.(a_1.\bar a_1)]
     }
    }
   }
  }
 ]
}
{
 \vlsbr
 (
  \vlderivation
  {
   \vlde{}{\{\cou\}}
   {
    \vls([a_1.\bar a_1].\cdots.[a_1.\bar a_1])
   }
   {
    \vlin{}{}
    {
     \vls[a_1.\bar a_1]
    }
    {
     \vlhy
     {
      \ttt
     }
    }
   }
  }
 \;\;\;.\;\;\;\cdots\;\;\;.\;\;\;
  \vlderivation
  {
   \vlde{}{\{\cou\}}
   {
    \vls([a_n.\bar a_n].\cdots.[a_n.\bar a_n])
   }
   {
    \vlin{}{}
    {
     \vls[a_n.\bar a_n]
    }
    {
     \vlhy
     {
      \ttt
     }
    }
   }
  }
 \;\;\;.\;\;\;
  \alpha
 )
}\quad,
\]
with atomic flow
\[
\psi'\;=\;
\atomicflow{
(-16, 12)*{\afvjdm{16}{\boldsymbol\epsilon}{}};
(  3, 20)*{\afaidex{}{}{}{}{}{}{26}{4}};
(  2, 18)*{\afaidex{}{}{}{}{}{}{8}{4}};
%-
(-10, 15)*{\afvj2};
(-10, 10)*{\affr68};
(-10, 10)*{\copy\contrup};
(-10,  5)*{\afvjm2};
( -2, 10)*{\affr68};
( -2, 10)*{\copy\contrup};
( -2,  5)*{\afvjm2};
( -9,  0)*{\affr{16}{8}};
( -1,  2)*{\aflabelleft{\phi}};
(-10, -5)*{\afvjm2};
(-10,-10)*{\affr68};
(-10,-10)*{\copy\contrdown};
(-10,-15)*{\afvj2};
( -2, -5)*{\afvjm2};
( -2,-10)*{\affr68};
( -2,-10)*{\copy\contrdown};
%-
( 6, 10)*{\affr68};
( 6, 10)*{\copy\contrup};
( 6,  5)*{\afvjm2};
(16, 15)*{\afvj2};
(16, 10)*{\affr68};
(16, 10)*{\copy\contrup};
(16,  5)*{\afvjm2};
( 6,  0)*{\affr{6}{8}};
( 9,  2)*{\aflabelleft{\psi_1}};
(11,  0)*{\cdots};
(16,  0)*{\affr{6}{8}};
(19,  2)*{\aflabelleft{\psi_n}};
( 6, -5)*{\afvjm2};
( 6,-10)*{\affr68};
( 6,-10)*{\copy\contrdown};
(16, -5)*{\afvjm2};
(16,-10)*{\affr68};
(16,-10)*{\copy\contrdown};
(16,-15)*{\afvj2};
%-
(-16,-12)*{\afvjum{16}{\boldsymbol\iota}{}};
(  3,-20)*{\afaiuex{}{}{}{}{}{}{26}{4}};
(  2,-18)*{\afaiuex{}{}{}{}{}{}{8}{4}};
}\quad.
\]
We then define $\MISR_n(\Phi,a_1,\dots,a_n)$ to be such that $\Psi'\to_\fris\MISR(\Phi,a_1,\dots,a_n)$, where, for $1\le i\le n$, $\psi_i$ in $\psi'$ is a sublfow of $\psi_i$ in the redex of Definition~\vref{definition:MultipleIsolatedSubflowsRemoval}.
\end{definition}

%------------------------------------------------------------
\begin{proposition}\label{proposition:MultipleIsolatedSubflowRemover}
Given the atoms, formulae and derivations described in Definition~\vref{definition:MultipleIsolatedSubflowsRemoval}, and the atoms $a_1$, $\dots$, $a_n$, and derivation $\Phi$ described in Definition~\ref{definition:MultipleIsolatedSubflowsRemover},
\begin{enumerate}
\item $\MISR_n(\Phi,a_1,\dots,a_n)$ is weakly streamlined with respect to $a$, $\dots$, $a_n$;
\item for any atom $b$,
\begin{itemize}
\item if $\Phi$ is weakly streamlined with respect to $b$, then $\MISR_n(\Phi,a_1,\dots,a_n)$ is weakly streamlined with respect to $b$, and
\item if $\Phi$ is on simple form with respect to $b$, then $\MISR_n(\Phi,a_1,\dots,a_n)$ is on simple form with respect to $b$; and
\end{itemize}
\item the size of $\MISR_n(\Phi,a_1,\dots,a_n)$ depends linearly on the size of\/ $\Phi$, and at most quadratically on $\max\{\size{\Gammasf_1},\dots,\size{\Gammasf_N}\}$.
\end{enumerate}
\end{proposition}

\begin{proof}
The statements follow by
\begin{enumerate}
\item Definition~\vref{definition:DerStreamlined} and Lemma~\vref{lemma:MultipleIsolatedSubflowsRemovalPaths};
\item Definitions~\ref{definition:DerStreamlined} and \ref{definition:DerSimpleForm}, and Lemma~\ref{lemma:MultipleIsolatedSubflowsRemovalPaths};
\item Proposition~\vref{proposition:DerivationSubstitution}, since $\max\{\size{\gamma_{0,1}},\dots,\size{\gamma_{N,n}}\}$ is less than or equal to $\max\{\size{\Gammasf_1},\dots,\size{\Gammasf_N}\}$.
\end{enumerate}
\end{proof}
%----------

%------------------------------------------------------
\begin{remark}\label{remark:FromGammasToThresholds}
Given the atoms, formulae and derivations described in Definition~\ref{definition:MultipleIsolatedSubflowsRemoval}, it follows from an argument by induction on $k$, that, for every $1\le i\le n$ and every $0\le k\le N$, the formula $\gamma_{k,i}$
\begin{itemize}
 \item is true if at least $k$ of the atoms $a_1$, $\dots$, $a_{i-1}$, $a_{i+1}$, $\dots$, $a_n$ are true; and
 \item is false if at least $N-k$ of the atoms $a_1$, $\dots$, $a_{i-1}$, $a_{i+1}$, $\dots$, $a_n$ are false.
\end{itemize}
It follows by contradiction that $N\ge n$. Furthermore, if $N=n$, we know that $\gamma_{k,i}$ is true if and only if at least $k$ of the atoms $a_1$, $\dots$, $a_{i-1}$, $a_{i+1}$, $\dots$, $a_n$ are true. This would make $\gamma_{k,i}$ a \emph{threshold formula}, as we will se in the next section.
\end{remark}
%-----------

%=============================
\input{global_transformations/threshold_formulae.tex}