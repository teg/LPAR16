\newcommand{\frfb}{{\mathsf{fb}}}
%---------------------------------------
\begin{definition}\label{definition:FourBoxes}
We define the reduction $\to_\frfb$ (where $\frfb$ stands for \emph{four boxes}) as follows, for any atomic flows $\phi$ and $\psi$ that do not contain interaction or cut vertices:
\[
\atomicflow{
(-8, 6)*{\afvjdm4{\boldsymbol{\epsilon}}{}};
( 0, 8)*{\afaidm{}{}{}{}{}{}};
( 8, 6)*{\afvjdm4{}{\boldsymbol{\epsilon'}}};
%-
(-5, 0)*{\affr88};
(-4, 2)*{\aflabelright\phi};
( 5, 0)*{\affr88};
( 6, 2)*{\aflabelright\psi};
%-
(-8,-6)*{\afvjum4{\boldsymbol{\iota}}{}};
( 0,-8)*{\afaium{}{}{}{}{}{}};
( 8,-6)*{\afvjum4{}{\boldsymbol{\iota'}}};
}
\quad\to_\frfb\quad
\atomicflow{
%left
(-27, 8)*{\afawdm{}{}{}{}};
(-19,16)*{\afvjdm8{\boldsymbol{\epsilon}}{}};
(-19, 8)*{\afacum{}{}{}{}{}{}};
(-24, 0)*{\affr88};
(-20, 2)*{\aflabelleft{f_1(\phi)}};
(-27,-8)*{\afawum{}{}{}{}};
(-19,-8)*{\afacdm{}{}{}{}{}{}};
(-19,-16)*{\afvjum8{\boldsymbol{\iota}}{}};
%top
(-15,18)*{\afawdm{}{}{}{\boldsymbol{\tilde\epsilon}}};
( -7,18)*{\afaidnw{}{}};
( -9,16)*{\afvjm4};
( -2,15)*{\afcjlm66};
(-12,10)*{\affr88};
( -8,12)*{\aflabelleft{f_2(\phi)}};
(-16, 1)*{\afcjrm2{10}};
( -9, 2)*{\afawum{}{}{}{}};
%bot
(-16,-1)*{\afcjlm2{10}};
( -9,-2)*{\afawdm{}{}{}{}};
(-12,-10)*{\affr88};
( -8, -8)*{\aflabelleft{f_3(\phi)}};
( -9,-16)*{\afvjm4};
( -2,-15)*{\afcjrm66};
( -7,-20)*{\afaiunw{}{}};
(-15,-18)*{\afawum{}{}{}{\boldsymbol{\tilde\iota}}};
%center
(-3, 12)*{\afvjdm{16}{}{\boldsymbol{\epsilon'}}};
( 3,  8)*{\afacdm{}{}{}{}{}{}};
( 7, 12)*{\afaidnw{}{}};
( 0,  0)*{\affr88};
( 4,  2)*{\aflabelleft{g(\psi)}};
( 7,-14)*{\afaiunw{}{}};
( 3, -8)*{\afacum{}{}{}{}{}{}};
(-3,-12)*{\afvjum{16}{}{\boldsymbol{\iota'}}};
%right
(15, 8)*{\afawdm{}{}{}{\boldsymbol{\hat\epsilon}}};
( 9, 8)*{\afvjm8};
(12, 0)*{\affr88};
(16, 2)*{\aflabelleft{f_4(\phi)}};
( 9,-8)*{\afvjm8};
(15,-8)*{\afawum{}{}{}{\boldsymbol{\hat\iota}}};
}\quad.
\]
\end{definition}

%---------------------------------------
\begin{theorem}\label{theorem:SoundFourBoxes}
Reduction\/ $\to_\frfb$ is sound.
\end{theorem}

%---------------------------------------
\begin{proof}
Let $\Phi$ be a derivation with flow $\phi'$, such that $\phi'\to_\frfb\psi'$. We show that there exists a derivation $\Psi$ with flow $\psi'$ and with the same premiss and conclusion as $\Phi$. In the following, we refer to the figure in Definition~\vref{definition:FourBoxes}.

We obtain $\Psi$, with atomic flow $\psi'$, from $\Phi$ by, for every atom occurrence $a^\phi$ in $\Phi$:
\begin{enumerate}
	\item If $a^\phi$ is not in the premiss or conclusion of $\Phi$, substitute it with the formula
	\[
	 \vls([a^{f_1(\phi)}.a^{f_2(\phi)}].[a^{f_3(\phi)}.a^{f_4(\phi)}])\quad.
	\]
	\item If $a^\phi$ is in the premiss or conclusion of $\Phi$, substitute it with the derivation
\[
\vlinf{}{}
{
 \vls(
  [
   a^{f_1(\phi)}
  \;.\;
   \vlinf{}{}{a^{f_2(\phi)}}{\fff}
  ]
 \;.\;
  [
   a^{f_3(\phi)}
  \;.\;
   \vlinf{}{}{a^{f_4(\phi)}}{\fff}
  ]
 )  
}
{a}
\quad\mbox{or}\quad
\vlinf{}{}
{a}
{
 \vls
 (
  [a^{f_1(\phi)}.a^{f_2(\phi)}]
 \;.\;
  [
   \vlinf{}{}{\ttt}{a^{f_3(\phi)}}
  \;.\;
   \vlinf{}{}{\ttt}{a^{f_4(\phi)}}
  ]
 )
}
\quad,
\]
respectively.
	\item Substitute rule instances $\vlinf{}{}{\vls[a^\phi.\bar a^\psi]}{\ttt}$ and $\vlinf{}{}{\fff}{\vls(a^\phi.\bar a^\psi)}$ with the derivations
\[
\vlderivation
{
 \vlin{=}{}{\vls[([\vlinf{}{}{a^{f_1(\phi)}}{\fff}\;.\;a^{f_2(\phi)}]\;.\;[\vlinf{}{}{a^{f_3(\phi)}}{\fff}\;.\;a^{f_4(\phi)}])\;.\;\vlinf{}{}{\bar a^\psi}{\vls[\bar a.\bar a]}]}
 {
  \vlin{\swi}{}{\vls[\vlinf{\swi}{}{\vls\vlsmallbrackets[(a^{f_2(\phi)}.a^{f_4(\phi)}).\bar a]}{\vls\vlsmallbrackets(a^{f_2(\phi)}.[a^{f_4(\phi)}.\bar a])}\;.\;\bar a]}
  {
   \vlhy{\vls(\vlinf{}{}{\vls[a^{f_2(\phi)}.\bar a]}{\ttt}\;.\;\vlinf{}{}{\vls[a^{f_4(\phi)}.\bar a]}{\ttt})}
  }
 }
}\qquad\mbox{and}
\]
\[
\vlderivation
{
 \vlin{\swi}{}{\vls[\vlinf{}{}{\fff}{\vls(a^{f_3(\phi)}.\bar a)}\;.\;\vlinf{}{}{\fff}{\vls(a^{f_4(\phi)}.\bar a)}]}
 {
  \vlin{=}{}{\vls(\vlinf{\swi}{}{\vls[a^{f_3(\phi)}.(a^{f_4(\phi)}.\bar a)]}{\vls([a^{f_3(\phi)}.a^{f_4(\phi)}].\bar a)}\;.\;\bar a)}
  {
   \vlhy{\vls(([\vlinf{}{}{\ttt}{a^{f_1(\phi)}}\;.\;\vlinf{}{}{\ttt}{a^{f_2(\phi)}}]\;.\;\vlsmallbrackets[a^{f_3(\phi)}.a^{f_4(\phi)}])\;.\;\vlinf{}{}{\vls(\bar a.\bar a)}{\bar a^\psi})}
  }
 }
}\quad,
\]
respectively.
	\item Substitute rule instances $\acd$, $\acu$, $\awd$, $\awu$ which apply to $a^\phi$ with $\cod$, $\cou$, $\wed$, $\weu$, respectively, applied to $\vls\vlsmallbrackets([a^{f_1(\phi)}.a^{\phi_2}].[a^{f_3(\phi)}.a^{f_4(\phi)}])$.
\end{enumerate}
\end{proof}

\TODO{Make a proposition? Rephrase?}

\begin{lemma}\label{lemma:FourBoxesSize}
For any two atomic flows $\phi$ and $\psi$ such that $\phi\to_\frfb\psi$ the size of $\psi$ is at most four times the size of $\phi$.
\end{lemma}

\begin{lemma}\label{lemma:FourBoxesStreamlining}
Given a polarity assignment $\pi$, and two atomic flows $\phi$ and $\psi$ such that $\phi\to_\frfb\psi$ and $\phi$ is weakly streamlined with respect to $\pi$ then $\psi$ is weakly streamlined with respect to $\pi$.
\end{lemma}

\begin{proof}
By studying the atomic flows in Definition~\vref{definition:FourBoxes} we can observe that for every path from an interaction vertex to a cut vertex in $\psi$ there is a path from an interaction vertex to a cut vertex in $\phi$ with the same polarity assignment.
\end{proof}

\begin{lemma}\label{lemma:FlowExistsSimpleForm}
Given an atomic flow $\phi$ and a polarity assignment $\pi$ there exists an atomic flow $\psi$, which is on simple form with respect to $\pi$, such that $\phi\to_\frfb\psi$.
\end{lemma}

\begin{proof}
Since we can represent $\phi$ with polarity assignment $\pi$ as follows:
\[
\atomicflow{
(-8, 6)*{\afvjdm4{\boldsymbol{\epsilon}}{}};
( 0, 8)*{\afaidm{}{}{}{}{}{}};
( 8, 6)*{\afvjdm4{}{\boldsymbol{\epsilon'}}};
%-
(-5, 0)*{\affr88};
(-6, 2)*{\aflabelleft\ppl};
( 5, 0)*{\affr88};
( 4, 2)*{\aflabelleft\pmi};
%-
(-8,-6)*{\afvjum4{\boldsymbol{\iota}}{}};
( 0,-8)*{\afaium{}{}{}{}{}{}};
( 8,-6)*{\afvjum4{}{\boldsymbol{\iota'}}};
}\quad.
\]
It is routine to check Definition~\vref{definition:FlowSimpleForm} and Definition~\vref{definition:FourBoxes} to verify that $\psi$ is on simple form with respect to $\pi$.
\end{proof}

\TODO{Reread this:}

\newcommand{\Simpl}{\mathsf{Simpl}}
\begin{definition}\label{definition:TheSimpleForm}
Given an atomic flow $\phi$ and a polarity assignment $\pi$, let $\psi$ be the atomic flow obtained in the proof of Lemma~\vref{lemma:FlowExistsSimpleForm}, such that $\phi\to_\frfb\psi$ and $\psi$ is on simple form with respect to $\pi$, then we say that $\psi$ is \emph{the simple form of $\phi$ with respect to $\pi$}, denoted $\Simpl(\phi,\pi)$. If $\phi$ is the atomic flow of the derivation $\Phi$ and $\psi$ is the atomic flow of the derivation $\Psi$, then we say that $\Psi$ is \emph{the simple form of $\Phi$ with respect to $\pi$}, denoted $\Simpl(\Phi,\pi)$.
\end{definition}

\TODO{Check:}

\begin{remark}\label{remark:FourBoxesDestroySimpleForm}
Given an atomic flow $\phi$ and a polarity assignment $\pi$, such that $\phi$ is not weakly streamlined with respect to $\bar\pi$, then $\Simpl(\phi,\pi)$ is not on simple form with respect to $\bar\pi$.
\end{remark}
