\TODO{More labels in the atomic flow in the definition to make sure it is unambiguous.}

\TODO{Come up with a better name.}

\newcommand{\frfb}{{\mathsf{fb}}}
%---------------------------------------
\begin{definition}\label{DefFourBox}
We define the reduction $\to_\frfb$ (where $\frfb$ stands for \emph{four boxes}) as follows, for any two atomic flows $\phi$ and $\psi$:
\[
\atomicflow{
(-8, 6)*{\afvjdm4{\boldsymbol{\epsilon}}{}};
( 0, 8)*{\afaidm{}{}{}{}{}{}};
( 8, 6)*{\afvjdm4{}{\boldsymbol{\epsilon'}}};
%-
(-5, 0)*{\affr88};
(-4, 2)*{\aflabelright\phi};
( 5, 0)*{\affr88};
( 6, 2)*{\aflabelright\psi};
%-
(-8,-6)*{\afvjum4{\boldsymbol{\iota}}{}};
( 0,-8)*{\afaium{}{}{}{}{}{}};
( 8,-6)*{\afvjum4{}{\boldsymbol{\iota'}}};
}
\quad\to_\frfb\quad
\atomicflow{
%left
(-27, 8)*{\afawdm{}{}{}{}};
(-19,15)*{\afvjdm6{\boldsymbol{\epsilon'}}{}};
(-19, 8)*{\afacum{}{}{}{}{}{}};
(-24, 0)*{\affr88};
(-20, 2)*{\aflabelleft{\psi_1}};
(-27,-8)*{\afawum{}{}{}{}};
(-19,-8)*{\afacdm{}{}{}{}{}{}};
(-19,-15)*{\afvjum6{\boldsymbol{\iota'}}{}};
%top
(-15,18)*{\afawdm{}{}{}{}};
( -7,18)*{\afaidnw{}{}};
( -9,16)*{\afvjm4};
( -2,15)*{\afcjlm66};
(-12,10)*{\affr88};
( -8,12)*{\aflabelleft{\psi_2}};
(-16, 1)*{\afcjrm2{10}};
( -9, 2)*{\afawum{}{}{}{}};
%bot
(-16,-1)*{\afcjlm2{10}};
( -9,-2)*{\afawdm{}{}{}{}};
(-12,-10)*{\affr88};
( -8, -8)*{\aflabelleft{\psi_3}};
( -9,-16)*{\afvjm4};
( -2,-15)*{\afcjrm66};
( -7,-20)*{\afaiunw{}{}};
(-15,-18)*{\afawum{}{}{}{}};
%center
(-3, 11)*{\afvjdm{14}{}{\boldsymbol{\epsilon}}};
( 3,  8)*{\afacdm{}{}{}{}{}{}};
( 7, 12)*{\afaidnw{}{}};
( 0,  0)*{\affr88};
( 4,  2)*{\aflabelleft\phi};
( 7,-14)*{\afaiunw{}{}};
( 3, -8)*{\afacum{}{}{}{}{}{}};
(-3,-11)*{\afvjum{14}{}{\boldsymbol{\iota}}};
%right
(15, 8)*{\afawdm{}{}{}{}};
( 9, 8)*{\afvjm8};
(12, 0)*{\affr88};
(16, 2)*{\aflabelleft{\psi_4}};
( 9,-8)*{\afvjm8};
(15,-8)*{\afawum{}{}{}{}};
}\quad,
\]
where $\psi_1$, $\psi_2$, $\psi_3$ and $\psi_4$ are isomorphic to $\psi$.
\end{definition}

%---------------------------------------
\begin{theorem}\label{ThFBSound}
Reduction\/ $\to_\frfb$ is sound.
\end{theorem}

\TODO{Tidy up derivations (commutativity before switches, etc.)}

%---------------------------------------
\begin{proof}
For every atom occurrence $a$ which maps to an edge in $\psi$;
\begin{enumerate}
	\item If $a$ is not in the premiss or conclusion of the derivation substitute it with the formula $\vls([a_1.a_2].[a_3.a_4])$, where $a=a_1=a_2=a_3=a_4$ and the subscripts denote which of $\psi_1$, $\psi_2$, $\psi_3$ or $\psi_4$ the atom occurrence maps to.
	\item If $a$ is in the premiss or conclusion of the derivation then substitute it with the derivations
\[
\vlinf{}{}
{
 \vls(
  [
   a_1
  \;.\;
   \vlinf{}{}{a_2}{\fff}
  ]
 \;.\;
  [
   a_3
  \;.\;
   \vlinf{}{}{a_4}{\fff}
  ]
 )
}
{a}
\qquad
\vlinf{}{}
{a}
{
 \vls[
  (a_1.a_2)
 \;.\;
  (
   \vlinf{}{}{\fff}{a_3}
  \;.\;
   \vlinf{}{}{\fff}{a_4}
  )
 ]
}
\quad,
\]
respectively.
	\item Substitute rule instances $\vlinf{}{}{\vls[a.\bar a]}{\ttt}$ and $\vlinf{}{}{\fff}{\vls(a.\bar a)}$ with the derivations
\[
\vlderivation
{
 \vlin{=}{}{\vls[([\vlinf{}{}{a_1}{\fff}\;.\;a_2]\;.\;[\vlinf{}{}{a_3}{\fff}\;.\;a_4])\;.\;\vlinf{}{}{\bar a}{\vls[\bar a.\bar a]}]}
 {
  \vlin{\swi}{}{\vls[\vlinf{\swi}{}{\vls[(a_2.a_4).\bar a]}{\vls(a_2.[a_4.\bar a])}\;.\;\bar a]}
  {
   \vlhy{\vls(\vlinf{}{}{\vls[a_2.\bar a]}{\ttt}\;.\;\vlinf{}{}{\vls[a_4.\bar a]}{\ttt})}
  }
 }
}\qquad
\vlderivation
{
 \vlin{\swi}{}{\vls[\vlinf{}{}{\fff}{\vls(a_3.\bar a)}\;.\;\vlinf{}{}{\fff}{\vls(a_4.\bar a)}]}
 {
  \vlin{=}{}{\vls(\vlinf{\swi}{}{\vls[a_3.(a_4.\bar a)]}{\vls([a_3.a_4].\bar a)}\;.\;\bar a)}
  {
   \vlhy{\vls(([\vlinf{}{}{\ttt}{a_1}\;.\;\vlinf{}{}{\ttt}{a_2}]\;.\;[a_3.a_4])\;.\;\vlinf{}{}{\vls(\bar a.\bar a)}{\bar a})}
  }
 }
}\quad,
\]
respectively.
	\item Substitute rule instances $\acd,\acu,\awd,\awu$ which apply to $a$ with their generic counterparts applied to $\vls([a_1.a_2].[a_3.a_4])$.
\end{enumerate}
It is now straightforward to verify that the derivation so obtained has the desired atomic flow.
\end{proof}

\begin{lemma}
Given an atomic flow $\phi$ and a polarity assignment $\pi$ there exists an atomic flow $\psi$, which is on simple form with respect to $\pi$, such that $\phi\to_\frfb\psi$.
\end{lemma}

\begin{lemma}
For any two atomic flows $\phi$ and $\psi$ such that $\phi\to_\frfb\psi$ the size of $\psi$ is at most four times the size of $\phi$.
\end{lemma}

\begin{lemma}
Given a polarity assignment $\pi$, and two atomic flows $\phi$ and $\psi$ such that $\phi\to_\frfb\psi$ and $\phi$ is weakly streamlined with respect to $\pi$ then $\psi$ is weakly streamlined with respect to $\pi$.
\end{lemma}
