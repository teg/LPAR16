\chapter{Flows and Derivations}

\section{Extracting Flows from Derivations}

%TODO: define atomic flows to always be considered modulo isomorphism
%TODO: redo the following proposition once the definition of Formalism A is set in stone
%---------------------------------------
\begin{proposition}\label{PropUnFl}
Given an\/ $\SKS$ derivation\/ $\Phi$, there is a unique atomic flow $\phi$ (modulo isomorphisms) such that:
\begin{enumerate}
%-------------------
\item there is a surjective map between the set of atom occurrences of\/ $\Phi$ and the set of edges of $\phi$;
%-------------------
\item for each vertical composition $\vlsmash{\vlinf{\rho}{}{\Phi_2}{\Phi_1}}$ of\/ $\Phi$, where $\rho\in\{\aid,\aiu,\awd,\awu,\acd,\acu\}$ and $\vlinf{\rho}{}{\beta}{\alpha}$ is a rule instance, the atom occurrences in $\vlinf{\rho}{}{\beta}{\alpha}$ are mapped to edges of $\phi$ such that the edges are related with vertices as indicated below, for each possible case of the inference rules:
\[
\begin{array}{@{}ccc@{}ccc@{}}
\vlinf{\aid}{}{\vls[a^\one.{\bar a^\two}]}{\ttt}&\mbox{to\/}&
\vcenter{\afaid\one{}{}\two{}{}}
\quad,&\qquad
\vlinf{\aiu}{}{\fff}{\vls(a^\one.{\bar a^\two})}&\mbox{to\/}&
\vcenter{\afaiu\one{}{}\two{}{}}
\quad,\\
\noalign{\medskip}
\vlinf{\awd}{}{a^\one}{\fff}                    &\mbox{to\/}&
\vcenter{\afawd{}{}{}\one{}} 
\quad,&\qquad
\vlinf{\awu}{}{\ttt}{a^\one}                    &\mbox{to\/}&
\vcenter{\afawu{}{}{}\one{}}
\quad,\\
\noalign{\medskip}
\vlinf{\acd}{}{a^\three}{\vls[a^\one.a^\two]}   &\mbox{to\/}&
\vcenter{\afacd\one{}{}\two{}\three}
\quad,&\qquad
\vlinf{\acu}{}{\vls(a^\two.a^\three)}{a^\one}   &\mbox{to\/}&
\vcenter{\afacu\two{}{}\three{}\one}
\quad,\\
\end{array}
\]
where the mapping is indicated by small numerals.
%-------------------
\item for each vertical composition of\/ $\Phi$ of kind
\[\hss
\begin{array}{@{}r@{}l@{}}
\vlinf{\swi}{}{\vls[(\alpha.\beta).\gamma]}
              {\vls(\alpha.[\beta.\gamma])}           \quad,&\qquad
\vlinf{\med}{}{\vls([\alpha.\gamma].[\beta.\delta])}
              {\vls[(\alpha.\beta).(\gamma.\delta)]}  \quad,      \\
\noalign{\smallskip}
\vlinf={}{\vls[\beta.\alpha]}{\vls[\alpha.\beta]}\quad,&\qquad
\vlinf={}{\vls(\beta.\alpha)}{\vls(\alpha.\beta)}\quad,      \\
\noalign{\smallskip}
\vlinf={}{\vls[\alpha.[\beta.\gamma]]}
         {\vls[[\alpha.\beta].\gamma]}                \quad,&\qquad
\vlinf={}{\vls[[\alpha.\beta].\gamma]}
         {\vls[\alpha.[\beta.\gamma]]}                \quad,      \\
\noalign{\smallskip}
\vlinf={}{\vls(\alpha.(\beta.\gamma))}
         {\vls((\alpha.\beta).\gamma)}                \quad,&\qquad
\vlinf={}{\vls((\alpha.\beta).\gamma)}
         {\vls(\alpha.(\beta.\gamma))}                \quad,      \\
\noalign{\smallskip}
\vlinf={}{\{\alpha\}}{\vls[\alpha.\fff]}           \quad,\qquad
\vlinf={}{\vls[\alpha.\fff]}{\{\alpha\}}           \quad,&\qquad
\vlinf={}{\{\alpha\}}{\vls(\alpha.\ttt)}        \qquad\hbox{and\/}\qquad
\vlinf={}{\vls(\alpha.\ttt)}{\{\alpha\}}
\end{array}
\]
all the atom occurrences in $\alpha$, $\beta$, $\gamma$ and $\delta$ in the premiss are respectively mapped to the same edges of $\phi$ as the atom occurrences in $\alpha$, $\beta$, $\gamma$ and $\delta$ in the conclusion.
\end{enumerate}
\end{proposition}

%---------------------------------------
\begin{definition}
Given a derivation $\Phi$, we say that the unique atomic flow $\phi$ defined in Proposition~\ref{PropUnFl} is the atomic flow \emph{associated with} the derivation $\Phi$. Sometimes, when an atom occurrence $a$ in $\Phi$ maps to an edge $\epsilon$ in $\phi$, we decorate $\epsilon$ with the label $a$.
\end{definition}

\begin{theorem}
Every atomic flow is associated with some derivation.
\end{theorem}

%---------------------------------------
\begin{proof}
First, we construct a derivation scheme $\Psi$ that `glues together' any two atomic flows without introducing any vertices. For every $\alpha$, $\beta$, the atomic flow of the following derivation consists only of edges (there are no vertices):
\[
\vlderivation
{
 \vlin{=}{}{\vls[(\alpha.\beta).\ttt]}
 {
  \vlin{=}{}
  {
   \vlsbr[\vlinf{\swi}{}{\vls[(\beta.\alpha).\ttt]}{\vls(\beta.[\alpha.\ttt])}\;.\;\ttt]
  }
  {
   \vlhy
   {
    \vlsbr[
    \vlderivation
    {
     \vlin{\swi}{}{\vls[([\alpha.\ttt].\beta).\ttt]}
     {
      \vlin{=}{}{\vls([\alpha.\ttt].[\beta.\ttt])}
      {
       \vlin{\med}{}{\vls([\alpha.\ttt].[\ttt.\beta])}
       {
        \vlin{=}{}{\vls[(\alpha.\ttt).(\ttt.\beta)]}
        {
         \vlhy{\vls[\alpha.\beta]}
        }
       }
      }
     }
    }
    \;\;\;\;.\;\;\;\;\ttt]
   }
  }
 }
}
\quad.
\]
%TODO: is it ok that the above derivation does not have a name?
%TODO: define super switch or something equivalent
%TODO: use double lines instead of dots and decide on a naming convention for repeated edges
We use the above derivation and $sus$ (see Remark~\ref{RemSupSwitch}) to `move' an atom $a$ from one context $\zeta\vlhole$ to another context $\xi\vlhole$, again with an associated atomic flow that is free of vertices:
\[
\vlder{}{\{\swi,\med\}}{\vls[(\xi\{a\}.\zeta\{\fff\}).\ttt]}
{
 \vlsbr[\vlinf{sus}{}{\vls[\xi\{a\}.\zeta\{\fff\}]}{\vls(\xi\{\ttt\}.\zeta\{a\})}\;.\;\ttt]
}
\quad.
\]
This construction can be used repeatedly to get the desired derivation $\Psi$, for $h\ge0$:
\[
\vlderivation                                                             {
\vlde{\Psi}{\{\swi,\med\}}
     {\vls[(\xi\{a_1 \}\cdots\{a_h \}.\zeta\{\fff\}\cdots\{\fff\}).\ttt]}{
\vlhy{\vls[(\xi\{\ttt\}\cdots\{\ttt\}.\zeta\{a_1 \}\cdots\{a_h \}).\ttt]}}}
\quad.
\]
We can now prove the theorem by induction on the number of vertices of a given atomic flow $\phi$. The cases where $\phi$ only has zero or one vertex are trivial. Let us then suppose that $\phi$ has more than one vertex; then $\phi$ can be considered as composed of two flows $\phi_1$ and $\phi_2$, each with less vertices than $\phi$, as follows:
\[
\atomicflow{
( 0  ,10)*{\afvjd4{\hat\epsilon_1}{}};
( 2  ,10)*{\cdots};
( 4  ,10)*{\afvjd4{}{\hat\epsilon_k}};
(12  ,10)*{\afvjd4{\tilde\epsilon_1}{}};
(14  ,10)*{\cdots};
(16  ,10)*{\afvjd4{}{\tilde\epsilon_m}};
(17  , 6)*{\aflabelleft \phi};
( 8  , 5)*{\affr{18}6};
( 0  , 0)*{\afvju4{\hat\epsilon'_1}{}};
( 2  , 0)*{\cdots};
( 4  , 0)*{\afvju4{}{\hat\epsilon'_l}};
(12  , 0)*{\afvju4{\tilde\epsilon'_1}{}};
(14  , 0)*{\cdots};
(16  , 0)*{\afvju4{}{\tilde\epsilon'_n}};
(-2  , 0)*{\invisiblemark};
(18.5, 0)*{\invisiblemark}}
=
\atomicflow{
(  6  ,20)*{\afvjd4{}{\tilde\epsilon_m}};
(  4  ,20)*{\cdots};
(  2  ,20)*{\afvjd4{\tilde\epsilon_1}{}};
(-11  ,20)*{\cdots};
( 12  ,16)*{\aflabelleft{\phi_1}};
(  4  ,15)*{\affr{16}6};
( -9  ,15)*{\afvjd{14}{}{\hat\epsilon_k}};
(-13  ,15)*{\afvjd{14}{\hat\epsilon_1}{}};
(  1  ,10)*{\afvju4{}{\epsilon_h}};
( -1  ,10)*{\cdots};
( -3  ,10)*{\afvju4{\epsilon_1}{}};
(  2  , 6)*{\aflabelleft{\phi_2}};
( 11  , 5)*{\afvju{14}{}{\tilde\epsilon'_n}};
(  7  , 5)*{\afvju{14}{\tilde\epsilon'_1}{}};
( -6  , 5)*{\affr{16}6};
(  9  , 0)*{\cdots};
( -4  , 0)*{\afvju4{}{\hat\epsilon'_l}};
( -6  , 0)*{\cdots};
( -8  , 0)*{\afvju4{\hat\epsilon'_1}{}};
( 13  , 0)*{\invisiblemark};
(-15.5, 0)*{\invisiblemark}}
\quad,
\]
where $h,k,l,m,n\ge0$ (this can possibly be done in many different ways). By the inductive hypothesis, there exist derivations $\vlder{\Phi_1}{}{\zeta\{a_1^{\epsilon_1}\}\cdots\{a_h^{\epsilon_h}\}}{\gamma}$ and $\vlder{\Phi_2}{}{\delta}{\xi\{a_1^{\epsilon_1}\}\cdots\{a_h^{\epsilon_h}\}}$ whose flows are, respectively, $\phi_1$ and $\phi_2$. Using these, we can build
\[
\vlder{\Psi}{}
{
 \vlsbr[(
 \vlder{\Phi_2}{}{\delta}{\xi\{a_1^{\epsilon_1}\}\cdots\{a_h^{\epsilon_h}\}}
 \;\;.\;\;
 \zeta\{\fff\}\cdots\{\fff\})
 \;\;.\;\;
 \ttt]
}
{
 \vlsbr[(\xi\{\ttt\}\cdots\{\ttt\}
 \;\;.\;\;
 \vlder{\Phi_1}{}{\zeta\{a_1^{\epsilon_1}\}\cdots\{a_h^{\epsilon_h}\}}{\gamma}
 )
 \;\;.\;\;
 \ttt]
}
\quad,
\]
whose flow is $\phi$.
\end{proof}

\section{Size}

\begin{theorem}
Given a derivation $\Phi$ with associated flow $\phi$, $|\Phi|\leq|\phi|^3$.
\end{theorem}