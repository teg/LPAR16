\chapter{Flows and Derivations}\label{chapter:FlowsAndDerivations}

\section{Extracting Flows from Derivations}\label{section:ExtractingFlowsFromDerivations}

\TODO{Define atomic flows to always be considered modulo isomorphism.}

\TODO{Redo the following proposition once the definition of Formalism A is set in stone.}

\TODO{Does it look better with or without the names of structural rules...?}

%---------------------------------------
\begin{proposition}\label{proposition:UniqueFlow}
Given an\/ $\SKS$ derivation\/ $\Phi$, there is a unique atomic flow $\phi$ (modulo isomorphisms) such that:
\begin{enumerate}
%-------------------
\item there is a surjective map between the set of atom occurrences of\/ $\Phi$ and the set of edges of $\phi$;
%-------------------
\item for each vertical composition $\vlsmash{\vlinf{\rho}{}{\Phi_2}{\Phi_1}}$ of\/ $\Phi$, where $\rho\in\{\aid,\aiu,\awd,\awu,\acd,\acu\}$ and $\vlinf{\rho}{}{\beta}{\alpha}$ is a rule instance, the atom occurrences in $\vlinf{\rho}{}{\beta}{\alpha}$ are mapped to edges of $\phi$ such that the edges are related with vertices as indicated below, for each possible case of the inference rules:
\[
\begin{array}{@{}ccc@{}ccc@{}}
\vlinf{}{}{\vls[a^\one.{\bar a^\two}]}{\ttt}&\mbox{to\/}&
\vcenter{\afaid\one{}{}\two{}{}}
\quad,&\qquad
\vlinf{}{}{\fff}{\vls(a^\one.{\bar a^\two})}&\mbox{to\/}&
\vcenter{\afaiu\one{}{}\two{}{}}
\quad,\\
\noalign{\medskip}
\vlinf{}{}{a^\one}{\fff}                    &\mbox{to\/}&
\vcenter{\afawd{}{}{}\one{}} 
\quad,&\qquad
\vlinf{}{}{\ttt}{a^\one}                    &\mbox{to\/}&
\vcenter{\afawu{}{}{}\one{}}
\quad,\\
\noalign{\medskip}
\vlinf{}{}{a^\three}{\vls[a^\one.a^\two]}   &\mbox{to\/}&
\vcenter{\afacd\one{}{}\two{}\three}
\quad,&\qquad
\vlinf{}{}{\vls(a^\two.a^\three)}{a^\one}   &\mbox{to\/}&
\vcenter{\afacu\two{}{}\three{}\one}
\quad,\\
\end{array}
\]
where the mapping is indicated by small numerals.
%-------------------
\item for each vertical composition of\/ $\Phi$ of kind
\[\hss
\begin{array}{@{}r@{}l@{}}
\vlinf{\swi}{}{\vls[(\alpha.\beta).\gamma]}
              {\vls(\alpha.[\beta.\gamma])}           \quad,&\qquad
\vlinf{\med}{}{\vls([\alpha.\gamma].[\beta.\delta])}
              {\vls[(\alpha.\beta).(\gamma.\delta)]}  \quad,      \\
\noalign{\smallskip}
\vlinf{\coor}{}{\vls[\beta.\alpha]}{\vls[\alpha.\beta]}\quad,&\qquad
\vlinf{\coand}{}{\vls(\beta.\alpha)}{\vls(\alpha.\beta)}\quad,      \\
\noalign{\smallskip}
\vlinf{\asor}{}{\vls[\alpha.[\beta.\gamma]]}
         {\vls[[\alpha.\beta].\gamma]}                \quad,&\qquad
\vlinf{\asor}{}{\vls[[\alpha.\beta].\gamma]}
         {\vls[\alpha.[\beta.\gamma]]}                \quad,      \\
\noalign{\smallskip}
\vlinf{\asand}{}{\vls(\alpha.(\beta.\gamma))}
         {\vls((\alpha.\beta).\gamma)}                \quad,&\qquad
\vlinf{\asand}{}{\vls((\alpha.\beta).\gamma)}
         {\vls(\alpha.(\beta.\gamma))}                \quad,      \\
\noalign{\smallskip}
\vlinf{\unor}{}{\alpha}{\vls[\alpha.\fff]}           \quad,\qquad
\vlinf{\unor}{}{\vls[\alpha.\fff]}{\alpha}           \quad,&\qquad
\vlinf{\unand}{}{\alpha}{\vls(\alpha.\ttt)}        \qquad\hbox{and\/}\qquad
\vlinf{\unand}{}{\vls(\alpha.\ttt)}{\alpha}
\end{array}
\]
all the atom occurrences in $\alpha$, $\beta$, $\gamma$ and $\delta$ in the premiss are respectively mapped to the same edges of $\phi$ as the atom occurrences in $\alpha$, $\beta$, $\gamma$ and $\delta$ in the conclusion.
\end{enumerate}
\end{proposition}

%---------------------------------------
\begin{definition}\label{definition:AssociatedFlow}
Given a derivation $\Phi$, we say that the unique atomic flow $\phi$ defined in Proposition~\ref{PropUnFl} is the atomic flow \emph{associated with} the derivation $\Phi$. Sometimes, when an atom occurrence $a$ in $\Phi$ maps to an edge $\epsilon$ in $\phi$, we decorate $\epsilon$ with the label $a$.
\end{definition}

\begin{theorem}\label{theorem:SurjectiveDerToFlow}
Every atomic flow is associated with some derivation.
\end{theorem}

\TODO{Show the first two derivations first with only their premiss/conclusion in the following proof, to make it more clear what we are trying to do.}

\TODO{Reintroduce super switch.}

\TODO{Decide on a convention of when to put the name of the derivation on the `stem' and when to say that the name equals the derivation.}

\TODO{Use double lines instead of $\cdots$ and change the proof to fit to this.}

%---------------------------------------
\begin{proof}
First, we construct a derivation scheme $\Psi$ that `glues together' any two atomic flows without introducing any vertices. For every $\alpha$, $\beta$, the atomic flow of the following derivation consists only of edges (there are no vertices):
\[
\vlderivation
{
 \vlin{=}{}{\vls[(\alpha.\beta).\ttt]}
 {
  \vlin{=}{}
  {
   \vlsbr[\vlinf{\swi}{}{\vls[(\beta.\alpha).\ttt]}{\vls(\beta.[\alpha.\ttt])}\;.\;\ttt]
  }
  {
   \vlhy
   {
    \vlsbr[
    \vlderivation
    {
     \vlin{\swi}{}{\vls[([\alpha.\ttt].\beta).\ttt]}
     {
      \vlin{=}{}{\vls([\alpha.\ttt].[\beta.\ttt])}
      {
       \vlin{\med}{}{\vls([\alpha.\ttt].[\ttt.\beta])}
       {
        \vlin{=}{}{\vls[(\alpha.\ttt).(\ttt.\beta)]}
        {
         \vlhy{\vls[\alpha.\beta]}
        }
       }
      }
     }
    }
    \;\;\;\;.\;\;\;\;\ttt]
   }
  }
 }
}
\quad.
\]
We use the above derivation and $\supers$ (see Remark~\ref{RemSuperSwitch}) to `move' an atom $a$ from one context $\zeta\vlhole$ to another context $\xi\vlhole$, again with an associated atomic flow that is free of vertices:
\[
\vlder{}{\{\swi,\med\}}{\vls[(\xi\{a\}.\zeta\{\fff\}).\ttt]}
{
 \vlsbr[\vlinf{\supers}{}{\vls[\xi\{a\}.\zeta\{\fff\}]}{\vls(\xi\{\ttt\}.\zeta\{a\})}\;.\;\ttt]
}
\quad.
\]
This construction can be used repeatedly to get the desired derivation $\Psi$, for $h\ge0$:
\[
\vlderivation                                                             {
\vlde{\Psi}{\{\swi,\med\}}
     {\vls[(\xi\{a_1 \}\cdots\{a_h \}.\zeta\{\fff\}\cdots\{\fff\}).\ttt]}{
\vlhy{\vls[(\xi\{\ttt\}\cdots\{\ttt\}.\zeta\{a_1 \}\cdots\{a_h \}).\ttt]}}}
\quad.
\]
We can now prove the theorem by induction on the number of vertices of a given atomic flow $\phi$. The cases where $\phi$ only has zero or one vertex are trivial. Let us then suppose that $\phi$ has more than one vertex; then $\phi$ can be considered as composed of two flows $\phi_1$ and $\phi_2$, each with less vertices than $\phi$, as follows:
\[
\atomicflow{
( 0  ,10)*{\afvjd4{\hat\epsilon_1}{}};
( 2  ,10)*{\cdots};
( 4  ,10)*{\afvjd4{}{\hat\epsilon_k}};
(12  ,10)*{\afvjd4{\tilde\epsilon_1}{}};
(14  ,10)*{\cdots};
(16  ,10)*{\afvjd4{}{\tilde\epsilon_m}};
(17  , 6)*{\aflabelleft \phi};
( 8  , 5)*{\affr{18}6};
( 0  , 0)*{\afvju4{\hat\epsilon'_1}{}};
( 2  , 0)*{\cdots};
( 4  , 0)*{\afvju4{}{\hat\epsilon'_l}};
(12  , 0)*{\afvju4{\tilde\epsilon'_1}{}};
(14  , 0)*{\cdots};
(16  , 0)*{\afvju4{}{\tilde\epsilon'_n}};
(-2  , 0)*{\invisiblemark};
(18.5, 0)*{\invisiblemark}}
=
\atomicflow{
(  6  ,20)*{\afvjd4{}{\tilde\epsilon_m}};
(  4  ,20)*{\cdots};
(  2  ,20)*{\afvjd4{\tilde\epsilon_1}{}};
(-11  ,20)*{\cdots};
( 12  ,16)*{\aflabelleft{\phi_1}};
(  4  ,15)*{\affr{16}6};
( -9  ,15)*{\afvjd{14}{}{\hat\epsilon_k}};
(-13  ,15)*{\afvjd{14}{\hat\epsilon_1}{}};
(  1  ,10)*{\afvju4{}{\epsilon_h}};
( -1  ,10)*{\cdots};
( -3  ,10)*{\afvju4{\epsilon_1}{}};
(  2  , 6)*{\aflabelleft{\phi_2}};
( 11  , 5)*{\afvju{14}{}{\tilde\epsilon'_n}};
(  7  , 5)*{\afvju{14}{\tilde\epsilon'_1}{}};
( -6  , 5)*{\affr{16}6};
(  9  , 0)*{\cdots};
( -4  , 0)*{\afvju4{}{\hat\epsilon'_l}};
( -6  , 0)*{\cdots};
( -8  , 0)*{\afvju4{\hat\epsilon'_1}{}};
( 13  , 0)*{\invisiblemark};
(-15.5, 0)*{\invisiblemark}}
\quad,
\]
where $h,k,l,m,n\ge0$ (this can possibly be done in many different ways). By the inductive hypothesis, there exist derivations $\vlder{\Phi_1}{}{\zeta\{a_1^{\epsilon_1}\}\cdots\{a_h^{\epsilon_h}\}}{\gamma}$ and $\vlder{\Phi_2}{}{\delta}{\xi\{a_1^{\epsilon_1}\}\cdots\{a_h^{\epsilon_h}\}}$ whose flows are, respectively, $\phi_1$ and $\phi_2$. Using these, we can build
\[
\vlder{\Psi}{}
{
 \vlsbr[(
 \vlder{\Phi_2}{}{\delta}{\xi\{a_1^{\epsilon_1}\}\cdots\{a_h^{\epsilon_h}\}}
 \;\;.\;\;
 \zeta\{\fff\}\cdots\{\fff\})
 \;\;.\;\;
 \ttt]
}
{
 \vlsbr[(\xi\{\ttt\}\cdots\{\ttt\}
 \;\;.\;\;
 \vlder{\Phi_1}{}{\zeta\{a_1^{\epsilon_1}\}\cdots\{a_h^{\epsilon_h}\}}{\gamma}
 )
 \;\;.\;\;
 \ttt]
}
\quad,
\]
whose flow is $\phi$.
\end{proof}

\section{Size}\label{section:FlowSize}

\begin{theorem}\label{theorem:FlowSize}
Given a derivation $\Phi$ with associated flow $\phi$, $|\Phi|\leq|\phi|^3$.
\end{theorem}

\section{Normal Forms of Derivations}\label{section:DerNormalForm}

\TODO{Ensure that all the normal forms of atomic flows have a corresponding definition for derivations.}

\begin{definition}\label{definition:DerStreamlined}
A derivation with associated atomic flow $\phi$ is \emph{weakly streamlined} (resp., \emph{streamlined}, \emph{super streamlined} and \emph{hyper streamlined}) if $\phi$ is \emph{weakly streamlined} (resp., \emph{streamlined}, \emph{super streamlined} and \emph{hyper streamlined}).
\end{definition}

\TODO{Add references to Propositions.}

\begin{remark}\label{remark:DerCutFree}
A streamlined proof is cut-free, a super streamlined proof is analytic and a hyper streamlined proof is in system $\KS$.
\end{remark}

\TODO{Try to remove the definition of $\ai$-free form.}

\begin{definition}\label{definition:aiDecomposedForm}
Given two derivations
\[
\vlder{\Phi}{}{\beta}{\alpha}
\quad\mbox{and}\quad
\Psi\;=\;
\vlder{\Psi'}{\SKS\setminus\{\aid,\aiu\}}
{
 \vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(b_m.\bar b_m)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(b_1.\bar b_1)}]
}
{
 \vlsbr(\vlinf{}{}{\vls[a_1.\bar a_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[a_n.\bar a_n]}{\ttt}\;.\;\alpha)
}\quad,
\]
for some atoms $a_1,\dots,a_n,b_1,\dots,b_m$, such that $\Phi$ and $\Psi$ have the same atomic flow, we say that $\Psi$ is an \emph{$\ai$-decomposed form of\/ $\Phi$}, and $\Psi'$ is an \emph{$\ai$-free form of\/ $\Phi$}.
\end{definition}

\TODO{Is it ok that the theorem does not mention the induced $\ai$-free form}

\begin{theorem}\label{theorem:aiDecomposedForm}
Given a derivation $\Phi$, an $\ai$-decomposed form of\/ $\Phi$ can be constructed.
\end{theorem}
\begin{proof}
Using Lemma~\ref{LemSuperSwitch} apply, from top-to-bottom and left-to-right, the following transformations to each of the identity and cut instances in $\Phi$:
\[
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlde{\Psi}{}{\xi\left\{\vlinf{}{}{\vls[a.{\bar a}]}{\ttt}\right\}}
  {
   \vlhy{\alpha}
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlin{\ssu}{}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlhy{\vlsbr(\vlinf{}{}{\vls[a.{\bar a}]}{\ttt}\;\;.\;\;\vlder{\Psi}{}{\xi\{\ttt\}}{\alpha})}
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlde{\Psi}{}{\xi\left\{\vlinf{}{}{\fff}{\vls(a.{\bar a})}\right\}}
  {
   \vlhy{\alpha}
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlin{\ssd}{}{\vlsbr[\vlder{\Psi'}{}{\beta}{\xi\{\fff\}}\;\;.\;\;\vlinf{}{}{\fff}{\vls(a.{\bar a})}]}
 {
  \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
  {
   \vlhy{\alpha}
  }
 }
}\quad
\]
to obtain an $\ai$-decomposed form of $\Phi$.
\end{proof}

\begin{remark}\label{remakr:aiDecomposedFormUnique}
The only reason to insist on doing the transformations in the above proof in a certain order is to ensure that the resulting derivation is unique. The uniqueness is useful in the following definition.
\end{remark}

\begin{definition}\label{definition:TheAiDecomposedForm}
Given a derivation $\Phi$, the $\ai$-decomposed (resp., $\ai$-free) form of $\Phi$ obtained as described in the proof of Theorem~\ref{ThmConstrDecomp} is called \emph{the $\ai$-decomposed} (resp., \emph{$\ai$-free}) \emph{form of\/ $\Phi$}.
\end{definition}

\begin{definition}\label{definition:DerCore}
Given a derivation $\vlder{\Phi}{}{\beta}{\alpha}$ with associated atomic flow $\phi$, such that $\phi_1$, $\dots$, $\phi_n$ are all the non-weakly-streamlined, connected subflows of $\phi$, a \emph{core of\/ $\Phi$} is defined to be a derivation
\[
\vlder{}{}{\vlsmallbrackets\vls[\beta.(a^{\mu'_n}_n.{\bar a^{\mu''_n}_n}).\cdots.(a^{\mu'_1}_1.{\bar a^{\mu'_1}_1})]}{\vlsmallbrackets\vls([a^{\lambda'_1}_1.{\bar a^{\lambda''_1}_1}].\cdots.[a^{\lambda'_n}_n.{\bar a^{\lambda'_n}_n}].\alpha)}
\]
with associated atomic flow $\Core(\phi)$, such that, for every $1\le i\le n$, $\lambda'_i$ and $\lambda''_i$ (resp., $\mu'_i$ and $\mu''_i$) are the new upper (resp., lower) edges of $\phi_i$ in $\Core(\phi)$.
\end{definition}

\begin{theorem}\label{therome:DerCore}
Given a derivation $\Phi$, a core of\/ $\Phi$ can be constructed.
\end{theorem}

\TODO{Rephrase in terms of $\ai$-decomposed form instead of $\ai$-free form.}

\TODO{Double check references.}

\TODO{There are some missing equations...}

\TODO{define $\star$ notation.}

\begin{proof}
Let $\phi$ be the atomic flow of $\Phi$, let $\phi_1$, $\dots$, $\phi_n$ be the connected, non-weakly-streamlined sublfows of $\phi$, and, for $1\le i\le n$, let $\lambda'_i$ and $\lambda''_i$ (resp., $\mu'_i$ and $\mu''_i$) be the new upper (resp., lower) edges of $\phi_i$ in $\Core(\phi)$. Furthermore, for some atoms $a_1$, $\dots$, $a_n$, $b_1$, $\dots$, $b_k$, $c_1$, $\dots$ $c_l$, such that, for $1\le i\le n$, occurrences of $a_i$ maps to edges in $\phi_i$, and all the occurrences of $b_1$, $\dots$, $b_k$, $c_1$, $\dots$ $c_l$ map to edges in a weakly-stremlined subflow of $\phi$, let the $\ai$-free form of $\Phi$ be $\Psi$. Then we build a core of $\Phi$ as follows:
\[
\vlder{\Psi}{\SKS\setminus\{\aid,\aiu\}}
{
 \vlsbr
 [
  \beta
 \;.\;
  \vlinf{}{}{\fff}{\vls(c_l.\bar c_l)}
 \;.\;\cdots\;.\;
  \vlinf{}{}{\fff}{\vls(c_1.\bar c_1)}
 \;.\;
  \vlinf{\cod^\star}{}{\vls(a^{\mu'_n}_n.\bar a^{\mu''_n}_n)}{\vls[(a_n.\bar a_n).\cdots.(a_n.\bar a_n)]}
 \;.\;\cdots\;.\;
 \vlinf{\cod^\star}{}{\vls(a^{\mu'_1}_1.\bar a^{\mu''_1}_1)}{\vls[(a_1.\bar a_1).\cdots.(a_1.\bar a_1)]}
 ]
}
{
 \vlsbr
 (
  \vlinf{\cou^\star}{}{\vls([a_1.\bar a_1].\cdots.[a_1.\bar a_1])}{\vls[a^{\lambda'_1}_1.\bar a^{\lambda''_1}_1]}
 \;.\;\cdots\;.\;
  \vlinf{\cou^\star}{}{\vls([a_n.\bar a_n].\cdots.[a_n.\bar a_n])}{\vls[a^{\lambda'_n}_n.\bar a^{\lambda''_n}_n]}
 \;.\;
  \vlinf{}{}{\vls[b_1.\bar b_1]}{\ttt}
 \;.\;\cdots\;.\;
  \vlinf{}{}{\vls[b_k.\bar b_k]}{\ttt}
 \;.\;
  \alpha
 )
}\quad.
\]
By studying Definitions~\ref{DefFlowCore} and \ref{DefDecompInt}, and the proof of Lemma~\ref{LemGenericContraction}, we can observe that the derivation has atomic flow $\Core(\phi)$.
\end{proof}

\TODO{In what sense is this unique?}

\begin{definition}\label{definition:DerTheCore}
Given a derivation $\Phi$, the core of $\Phi$ obtained as described in the proof of Theorem~\ref{ThmExistCore} is called \emph{the core of\/ $\Phi$}, denoted $\Core(\Phi)$.
\end{definition}


\begin{definition}\label{definition:DerExperiment}
Given a proof $\vlproof{\Pi}{}{\alpha}$ with associated atomic flow $\phi$ and a polarity assignment, $\pi$, to $\phi$, such that $\phi_1$, $\dots$, $\phi_n$ are all the non-weakly-cut-free, connected subflows of $\phi$, an \emph{experiment on\/ $\Pi$ with respect to $\pi$} is defined to be a derivation
\[
\vlder{}{}{\alpha}{\vlsmallbrackets\vls((a^{\lambda'_{1,1}}_1.\cdots.a^{\lambda'_{1,k_1}}_1).\cdots.(a^{\lambda'_{n,1}}_n.\cdots.a^{\lambda'_{n,k_n}}_n))}
\]
with associated atomic flow $\Exp(\phi,\pi)$, such that, for every $1\le i\le n$, $\lambda'_{i,1}$, $\dots$, $\lambda'_{i,k_i}$ are the new upper edges of $\phi_i$.
\end{definition}

\TODO{Update definition of `new upper edges of $\phi_i$' to also mention $\Exp$}

\TODO{We are glossing over some associativity/commutativity...}

\begin{theorem}\label{theorem:DerExperiment}
Given a proof\/ $\vlproof{\Pi}{}{\alpha}$ with associated atomic flow $\phi$, and a polarity assignment, $\pi$, to $\phi$, an experiment on $\Pi$ with respect to $\pi$ can be constructed.
\end{theorem}

\begin{proof}
Let $\phi_1$, $\dots$, $\phi_n$ be all the non-weakly-cut-free, connected subflows of $\phi$ and, for every $1\le i\le n$, let $\lambda'_{i,1}$, $\dots$, $\lambda'_{i,k_i}$ be the new upper edges of $\phi_i$ in $\Exp(\phi,\pi)$.

For every $1\le i\le n$ and every $1\le j\le k_i$, substitute $\vlinf{}{}{\vls[a_i^{\lambda'_{i,j}}.\bar a_i]}{\ttt}$ with $\vlsbr[a_i^{\lambda'_{i,j}}.\vlinf{}{}{\bar a_i}{\fff}]$ in the $\ai$-decomposed form of $\Pi$ to obtain a derivation with atomic flow $\Exp(\phi,\pi)$:
\[
\vlder{}{}{\alpha}
{
 \vlsbr
 (
  (
   [a_1^{\lambda'_{1,1}}.\vlinf{}{}{\bar a_1}{\fff}]
  \;.\;\cdots\;.\;
   [a_1^{\lambda'_{1,k_1}}.\vlinf{}{}{\bar a_1}{\fff}]
  )
 \;.\;\cdots\;.\;
  (
   [a_n^{\lambda'_{n,1}}.\vlinf{}{}{\bar a_n}{\fff}]
  \;.\;\cdots\;.\;
   [a_n^{\lambda'_{n,k_n}}.\vlinf{}{}{\bar a_n}{\fff}]
  )
 )
}\quad.
\]
\end{proof}

\begin{definition}\label{definition:DerTheExperiment}
Given a proof $\Pi$ and a polarity assignment to its atomic flow $\pi$, the experiment on $\Phi$ with respect to $\pi$ obtained as described in the proof of Theorem~\ref{ThmConstrExp} is called \emph{the experiment on\/ $\Pi$ with respect to $\pi$}, denoted $\Exp(\Pi,\pi)$.
\end{definition}

\TODO{In what sense is this unique?}