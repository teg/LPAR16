\chapter{The Functorial Calculus}\label{chapter:TheFunctorialCalculus}

\section{Definitions}\label{section:FunctorialCalculus}

\TODO{Give credit to Francois}

\newcommand{\fff}{\mathsf f}
\newcommand{\ttt}{\mathsf t}
\newcommand{\size}[1]{{\left\vert #1\right\vert}}\vlupdate\size


\TODO{Definitions~\vrefrange{definition:Formula}{definition:InferenceRuleInstance} and Definition~\vref{definition:CoS} is taken from \emph{On the Proof Complexity of Deep Inference}.}

\TODO{Note: Removed negated formula variables; DeMorgan dual of formulae; formula variables from the examples and the size of the context.} 

\begin{definition}\label{definition:Formula}
\emph{Formulae} of the \emph{functorial calculus} are denoted by $\alpha$, $\beta$, $\gamma$, $\delta$ and are freely built from:
\begin{itemize}
 \item \emph{units}, like $\fff$ (false) and $\ttt$ (true),
 \item \emph{atoms} $a$, $b$, $c$, $d$ and $\bar a$, $\bar b$, $\bar c$, $\bar d$,
 \item \emph{formula variables} $A$, $B$, $C$, $D$, and
 \item \emph{logical relations}, like \emph{disjunction} $\vlsbr[\alpha.\beta]$ and \emph{conjunction} $\vlsbr(\alpha.\beta)$.
\end{itemize}
A formula is \emph{ground} if it contains no variables. We usually omit external brackets of formulae, and sometimes we omit dispensable brackets under associativity. We use $\equiv$ to denote literal equality of formulae. The \emph{size} $\size\alpha$ of a formula $\alpha$ is the number of unit, atom and variable occurrences appearing in it. On the set of atoms there is an involution $\bar\cdot$, called \emph{negation} (\emph{i.e.}, $\bar\cdot$ is a bijection from the set of atoms to itself such that $\bar{\bar a}\equiv a$); we require that $\bar a\not\equiv a$ for every $a$; when both $a$ and $\bar a$ appear in a formula, we mean that atom $a$ is mapped to by $\bar a$ by $\bar\cdot$. A \emph{context} is a formula where one \emph{hole} $\vlhole$ appears in the place of a subformula; for example, $\vls[a.(b.\vlhole)]$ is a context; the generic context is denoted by $\xi\vlhole$. The hole can be filled with formulae; for example, if $\xi\vlhole\equiv\vls(b.[\vlhole.c])$, then $\xi\{a\}\equiv\vls(b.[a.c])$, $\xi\{b\}\equiv\vls(b.[b.c])$ and $\xi\{\vls(a.b)\}\equiv\vls(b.[(a.b).c])$.
\end{definition}

\TODO{Note: I removed mention of $\rho$ and $\sigma$ as well as DeMorgan duals. I changed the example.}

\begin{definition}\label{definition:RenamingSubstitution}
A \emph{renaming} is a map from the set of atoms to itself, and it is denoted by $\{a_1/b_1,a_2/b_2,\dots\}$. A renaming of $\alpha$ by $\{a_1/b_1,a_2/b_2,\dots\}$ is indicated by $\alpha\{a_1/b_1,a_2/b_2,\dots\}$ and is obtained by simultaneously substituting every occurrence of $a_i$ in $\alpha$ by $b_i$ and every occurrence of $\bar a_i$ by $\bar b_i$; for example, if $\alpha\equiv\vls(a.[b.(a.[\bar a.c])])$ then $\alpha\{a/\bar b,\bar b/c\}\equiv\vls(\bar b.[\bar c.(\bar b.[b.c])])$. A \emph{substitution} is a map from the set of formula variables to formulae, denoted by $\{A_1/\beta_1,A_2/\beta_2,\dots\}$. An \emph{instance} of $\alpha$ by $\{A_1/\beta_1,A_2/\beta_2,\dots\}$ is indicated by $\alpha\{A_1/\beta_1,A_2/\beta_2,\dots\}$ and is obtained by simultaneously substituting every occurrence of variable $A_i$ in $\alpha$ by formula $\beta_i$; for example if $\alpha\equiv\vls[A.(b.c)]$ then $\alpha\{A/\vls(c.\bar b)\}\equiv\vls[(c.\bar b).(b.c)]$.
\end{definition}

\begin{definition}\label{definition:InferenceRuleInstance}
An \emph{inference rule} $\rho$ is an expression $\vlinf{\rho}{}{\beta}{\alpha}$, where formulae $\alpha$ and $\beta$ are called \emph{premiss} and \emph{conclusion}, respectively. An \emph{inference rule instance} $\vlinf{\rho}{}{\delta}{\gamma}$ of $\vlinf{\rho}{}{\beta}{\alpha}$ is such that $\gamma\equiv\alpha\{a_1/b_1,a_2/b_2,\dots\}\{A_1/\beta_1,A_2/\beta_2,\dots\}$ and $\delta\equiv\beta\{a_1/b_1,a_2/b_2,\dots\}\{A_1/\beta_1,A_2/\beta_2,\dots\}$, for some renaming $\{a_1/b_1,a_2/b_2,\dots\}$ and substiution $\{A_1/\beta_1,A_2/\beta_2,\dots\}$.
\end{definition}

\TODO{Define size of derivation}

\begin{definition}\label{definition:Derivation}
Fix a set of formulae, a set of inference rule instances and a set of logical connectives, then a \emph{(functorial calculus) derivation $\vlder{\Psi}{}{\beta}{\alpha}$ from (the formula) $\alpha$ to (the formula) $\beta$}, is defined to be
\begin{enumerate}
 \item a formula, $\Psi=\alpha=\beta$,

 \item a vertical composition
 \[
 \Psi\;=\;
 \vlinf{\rho}{}
 {
  \vlder{\Phi_2}{}
  {
   \beta_2
  }
  {
   \alpha_2
  }
 }
 {
  \vlder{\Phi_1}{}
  {
   \beta_1
  }
  {
   \alpha_1
  }
 }
 \quad,
 \]
 where $\vlinf{\rho}{}{\alpha_2}{\beta_1}$ is an inference rule instance, and $\vlder{\Phi_1}{}{\beta_1}{\alpha_1}$ and $\vlder{\Phi_2}{}{\beta_2}{\alpha_1}$ are derivations, and
 \item a horizontal composition
 \[
 \Psi=\vlder{\circ(\Phi_1,\dots,\Phi_n)}{}{\circ(\beta_1,\dots,\beta_n)}{\circ(\alpha_1,\dots,\alpha_n)}\quad,
 \]
 where $\circ$ is an $n$-ary logical connective, $\alpha=\circ(\alpha_1,\dots,\alpha_n)$, $\beta=\circ(\beta_1,\dots,\beta_n)$ and $\vlder{\Phi_1}{}{\beta_1}{\alpha_1}$, $\dots$, $\vlder{\Phi_n}{}{\beta_n}{\alpha_n}$ are derivations.
\end{enumerate}
\end{definition}

\begin{remark}\label{remark:DerAssociativeComposition}
Given derivations $\vlder{\Phi_1}{}{\beta_1}{\alpha_1}$, $\vlder{\Phi_2}{}{\beta_2}{\alpha_2}$ and $\vlder{\Phi_3}{}{\beta_3}{\alpha_3}$, and inference rule instances $\vlinf{\rho_1}{}{\alpha_2}{\beta_1}$ and $\vlinf{\rho_2}{}{\alpha_3}{\beta_2}$ we consider
\[
\vlinf{\rho_2}{}
{
 \vlder{\Phi_3}{}
 {
  \beta_3
 }
 {
  \alpha_3
 }
}
{
 \left(
 \vlinf{\rho_1}{}
 {
  \vlder{\Phi_2}{}
  {
   \beta_2
  }
  {
   \alpha_2
  }
 }
 {
  \vlder{\Phi_1}{}
  {
   \beta_1
  }
  {
   \alpha_1
  }
 }
 \right)
}
\quad\mbox{and}\quad
\vlinf{\rho_1}{}
{
 \left(
 \vlinf{\rho_2}{}
 {
  \vlder{\Phi_3}{}
  {
   \beta_3
  }
  {
   \alpha_3
  }
 }
 {
  \vlder{\Phi_2}{}
  {
   \beta_2
  }
  {
   \alpha_2
  }
 }
 \right)
}
{
 \vlder{\Phi_1}{}
 {
  \beta_1
 }
 {
  \alpha_1
 }
}
\quad,
\]
to be equal, and we denote them both by:
\[
\vlderivation
{
 \vlde{\Phi_3}{}
 {
  \beta_3
 }
 {
  \vlin{\rho_2}{}
  {
   \alpha_3
  }
  {
   \vlde{\Phi_2}{}
   {
    \beta_2
   }
   {
    \vlin{\rho_1}{}
    {
     \alpha_2
    }
    {
     \vlde{\Phi_1}{}
     {
      \beta_1
     }
     {
      \vlhy
      {
       \alpha_1
      }
     }
    }
   }
  }
 }
}
\quad.
\]
\end{remark}

\begin{lemma}\label{lemma:DerComposition}
Given two derivations $\vlder{\Phi_1}{}{\beta}{\alpha}$ and $\vlder{\Phi_2}{}{\gamma}{\beta}$, a derivation $\vlder{\Phi_1;\Phi_2}{}{\gamma}{\alpha}$ can be constructed.
\end{lemma}

\begin{proof}
We argue by structural induction on $\Phi_1$ and $\Phi_2$
\begin{enumerate}

 \item if $\Phi_1=\beta$ then $\Psi=\Phi_2$;

 \item if $\Phi_2=\beta$ then $\Psi=\Phi_1$;

 \item if $\Phi_1\;=\;\vlder{\vlinf{\rho}{}{\Phi_1''}{\Phi_1'}}{}{\beta}{\alpha}$, then $\Phi_1'';\Phi_2$ can be constructed by the inductive hypothesis and we can build $\Psi\;=\;\vlder{\vlinf{\rho}{}{\Phi_1'';\Phi_2}{\Phi_1'}}{}{\gamma}{\alpha}$;

 \item if $\Phi_2\;=\;\vlder{\vlinf{\rho}{}{\Phi_2''}{\Phi_2'}}{}{\gamma}{\beta}$, then $\Phi_1;\Phi_2'$ can be constructed by the inductive hypothesis and we can build $\Psi\;=\;\vlder{\vlinf{\rho}{}{\Phi_2''}{\Phi_1;\Phi_2'}}{}{\gamma}{\alpha}$;

 \item if $\Phi_1=\circ(\Phi_{1,1},\dots,\Phi_{1,n})$ and $\Phi_2=\circ(\Phi_{2,1},\dots,\Phi_{2,n})$ then $\Phi_{1,1};\Phi_{2,1},\dots,\Phi_{1,n};\Phi_{2,n}$ can be constructed by the inductive hypothesis and we can build $\Phi_1;\Phi_2=\circ(\Phi_{1,1};\Phi_{2,1},\dots,\Phi_{1,n};\Phi_{2,n})$.

\end{enumerate}
\end{proof}

\begin{definition}\label{definition:DerComposition}
Given $\Phi_1$ and $\Phi_2$ as in the premiss of Lemma~\vref{lemma:DerComposition}, the derivation $\Phi_1;\Phi_2$ constructed in the proof of the lemma is denoted
\[
\vlderivation
{
 \vlde{\Phi_2}{}{\gamma}
 {
  \vlde{\Phi_1}{}{\beta}
  {
   \vlhy{\alpha}
  }
 }
}\quad.
\]
\end{definition}

\section{Comparison with the Calculus of Structures}\label{section:CalculusOfStructures}


\begin{definition}\label{definition:CoS}
For some context $\xi\vlhole$, a \emph{calculus of structures inference step, generated by} rule $\vlinf{\rho}{}{\beta}{\alpha}$ \emph{via} its instance $\vlinf{\rho}{}{\delta}{\gamma}$, is the expression $\vlinf{\rho}{}{\xi\{\delta\}}{\xi\{\gamma\}}$. A \emph{calculus of structures derivation} $\vlder{\Psi}{}{\beta}{\alpha}$ from (the formula) $\alpha$ to (the formula) $\beta$, is defined to be
\begin{enumerate}
 \item a formula, $\Psi=\alpha=\beta$,

 \item a vertical composition
 \[
 \Psi\;=\;
 \vlinf{\rho}{}
 {
  \vlder{\Phi_2}{}
  {
   \beta_2
  }
  {
   \alpha_2
  }
 }
 {
  \vlder{\Phi_1}{}
  {
   \beta_1
  }
  {
   \alpha_1
  }
 }
 \quad,
 \]
 where $\vlinf{\rho}{}{\beta_2}{\alpha_1}$ is an inference step, and $\vlder{\Phi_1}{}{\beta_1}{\alpha_1}$ and $\vlder{\Phi_2}{}{\beta_2}{\alpha_1}$ are calculus of structures derivations.
\end{enumerate}
\end{definition}

\begin{theorem}
The functorial calculus p-simulates the calculus of structures and the calculus of structures p-simulates the functorial calculus.
\end{theorem}

\begin{theorem}
A functorial calculus derivation corresponds to an equivalence class of calculus of structures derivations modulo bureaucracy of type A.
\end{theorem}

\TODO{Compare with the paper by Stephane and Kai.}